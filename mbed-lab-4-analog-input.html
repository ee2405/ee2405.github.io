<!DOCTYPE html>
<html lang="en">
<head>

        <title>mbed Lab 4 Analog Input</title>
        <meta charset="utf-8" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/pygment.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/LARC.css" />

 
        <script src="https://ee2405.github.io/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="https://ee2405.github.io/">Embedded System Lab <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="https://ee2405.github.io/">Home</a></li>

                <li><a href="https://ee2405.github.io/pages/lab-schedule.html">Lab Schedule</a></li>
                <li><a href="https://ee2405.github.io/pages/class-rules.html">Class Rules</a></li>
              <form class="navbar-form navbar-right" role="search" action="https://ee2405.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <div class="form-group">
                  <div class="input-group">
                    <input type="text" name="q" id="tipue_search_input" class="form-control search-query" placeholder="Search" required />
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit"><i class="fa
                          fa-search fa-fw"></i></button>
                    </span>
                  </div>
                </div>
              </form>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="https://ee2405.github.io/mbed-lab-4-analog-input.html" rel="bookmark"
                   title="Permalink to mbed Lab 4 Analog Input">mbed Lab 4 Analog Input</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2022-03-02T16:00:00+08:00">
                 3 02, 2022
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="https://ee2405.github.io/author/jing-jia-liou.html"> Jing-Jia Liou</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <!-- usage: include:: LARC_def.txt -->
<!-- please check https://github.com/nevir/groc/issues/63#issuecomment-24299684 for pygments' lexer list -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#lab-due" id="toc-entry-1">1&nbsp;&nbsp;&nbsp;Lab Due</a></li>
<li><a class="reference internal" href="#lab-introduction" id="toc-entry-2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></li>
<li><a class="reference internal" href="#equipment-list" id="toc-entry-3">3&nbsp;&nbsp;&nbsp;Equipment List</a></li>
<li><a class="reference internal" href="#lab-description" id="toc-entry-4">4&nbsp;&nbsp;&nbsp;Lab Description</a><ul class="auto-toc">
<li><a class="reference internal" href="#lecture-notes" id="toc-entry-5">4.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></li>
<li><a class="reference internal" href="#control-led-by-analogout" id="toc-entry-6">4.2&nbsp;&nbsp;&nbsp;Control LED by AnalogOut</a></li>
<li><a class="reference internal" href="#control-led-by-pwmout" id="toc-entry-7">4.3&nbsp;&nbsp;&nbsp;Control LED by PwmOut</a></li>
<li><a class="reference internal" href="#analogin-with-fft-analysis" id="toc-entry-8">4.4&nbsp;&nbsp;&nbsp;AnalogIn with FFT analysis</a><ul class="auto-toc">
<li><a class="reference internal" href="#connect-circuit" id="toc-entry-9">4.4.1&nbsp;&nbsp;&nbsp;Connect circuit</a></li>
<li><a class="reference internal" href="#new-mbed-program" id="toc-entry-10">4.4.2&nbsp;&nbsp;&nbsp;New Mbed program</a></li>
<li><a class="reference internal" href="#setup-picoscope" id="toc-entry-11">4.4.3&nbsp;&nbsp;&nbsp;Setup Picoscope</a></li>
<li><a class="reference internal" href="#install-python-packages" id="toc-entry-12">4.4.4&nbsp;&nbsp;&nbsp;Install Python packages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#measure-the-conversion-timing" id="toc-entry-13">4.5&nbsp;&nbsp;&nbsp;Measure the conversion timing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#demo-and-checkpoints" id="toc-entry-14">5&nbsp;&nbsp;&nbsp;Demo and Checkpoints</a></li>
<li><a class="reference internal" href="#reference-list" id="toc-entry-15">6&nbsp;&nbsp;&nbsp;Reference List</a></li>
</ul>
</div>
<div class="tasklist docutils container">
<p>The goal of this lab is to learn:</p>
<ol class="arabic simple">
<li>Analog input of mbed</li>
<li>Serial communication with PC</li>
</ol>
</div>
<div class="section" id="lab-due">
<h2><a class="toc-backref" href="#toc-entry-1">1&nbsp;&nbsp;&nbsp;Lab Due</a></h2>
<p><strong>Mar. 2, 2022</strong></p>
</div>
<div class="section" id="lab-introduction">
<h2><a class="toc-backref" href="#toc-entry-2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></h2>
<p>The AnalogIn API is used to read (measure) an external voltage applied to an input pin.
An analog to digital converter circuit (ADC) will sample and quantized the signal to digital formats.</p>
<p>Because we need a ADC circuit to read from an analog signal, only certain pins of B_L4S5I_IOT01A are
connected to ADC and capable of making these measurements.
Please check the documentation of B_L4S5I_IOT01A for ADC pins.</p>
</div>
<div class="section" id="equipment-list">
<h2><a class="toc-backref" href="#toc-entry-3">3&nbsp;&nbsp;&nbsp;Equipment List</a></h2>
<ol class="arabic simple">
<li>B_L4S5I_IOT01A * 1</li>
<li>PicoScope * 1</li>
<li>Wire * 20</li>
<li>Breadboard * 1</li>
<li>LED * 1</li>
</ol>
</div>
<div class="section" id="lab-description">
<h2><a class="toc-backref" href="#toc-entry-4">4&nbsp;&nbsp;&nbsp;Lab Description</a></h2>
<div class="section" id="lecture-notes">
<h3><a class="toc-backref" href="#toc-entry-5">4.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></h3>
<ul class="simple">
<li>Chapter 5: Analog Input <a class="reference external" href="notes/ch5_adc.pdf">ch5_adc.pdf</a></li>
</ul>
</div>
<div class="section" id="control-led-by-analogout">
<h3><a class="toc-backref" href="#toc-entry-6">4.2&nbsp;&nbsp;&nbsp;Control LED by AnalogOut</a></h3>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<div class="instruct docutils container">
For all Mbed and Python programs, please push the source codes to your GitHub repo.</div>
<ol class="arabic">
<li><p class="first">Connect the B_L4S5I_IOT01A to the picoscope</p>
<p>In this configuration, B_L4S5I_IOT01A will read an analog signal and convert it back to analog signal again
to an output pin. We will observe the output pin with both picoscope and a LED.</p>
<ol class="arabic">
<li><p class="first">Connect the picoscope to your computer. <a class="reference external" href="labs/img/Analog_Input/1_1_2.jpg">Screenshot</a></p>
</li>
<li><p class="first">Connect the first probe to the <span class="hl">Channel A</span> <a class="reference external" href="labs/img/Analog_Input/1_1_3.jpg">like this</a>.</p>
</li>
<li><p class="first">Connect the second probe to the port <span class="hl">AWG</span> of picoscope <a class="reference external" href="labs/img/Analog_Input/3_1_4.jpg">like this</a></p>
</li>
<li><p class="first">Connect the first probe to the pin of <span class="hl">D7</span> and the second to the pin of <span class="hl">A0</span> . <a class="reference external" href="labs/img/Analog_Input/B_L4S5I_IOT01A_A0_D7_LED.jpg">Screenshot</a></p>
<img alt="circuit" src="labs/img/Analog_Input/3_1_LED_Analog_A0_D7_new1.jpg" />
</li>
</ol>
</li>
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>4_1_LED_Analog</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="n">AnalogOut</span><span class="w"> </span><span class="nf">Aout</span><span class="p">(</span><span class="n">D7</span><span class="p">);</span><span class="w"></span>
<span class="linenos">4</span><span class="n">AnalogIn</span><span class="w"> </span><span class="nf">Ain</span><span class="p">(</span><span class="n">A0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="linenos">6</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"></span>
<span class="linenos">7</span><span class="w">    </span><span class="n">Aout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ain</span><span class="p">;</span><span class="w"></span>
<span class="linenos">8</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">9</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and run the program</p>
</li>
<li><p class="first">Start the picoscope app</p>
</li>
<li><p class="first">Setup picoscope to generate a square wave</p>
<ol class="arabic">
<li><p class="first">Select &quot;input range A&quot; as <span class="hl">+-5</span> and collection time as <span class="hl">1 ms/div</span>:
<a class="reference external" href="labs/img/Analog_Input/3_1_1.png">screenshot</a></p>
</li>
<li><p class="first">Generate the <a class="reference external" href="labs/img/Analog_Input/3_1_2.png">analog signal</a>.</p>
<p>There are many different signal types that we can select.
Please choose <span class="hl">square wave</span> as a demo: <a class="reference external" href="labs/img/Analog_Input/3_1_3.png">screenshot</a></p>
</li>
</ol>
</li>
<li><p class="first">A square wave will show on the <a class="reference external" href="labs/img/Analog_Input/3_1_6.png">monitor</a>.</p>
<p>Also note that the LED will blink according to the frequency of the square wave.</p>
</li>
<li><p class="first">Screenshot your result of picoscope.</p>
</li>
</ol>
</div>
<div class="section" id="control-led-by-pwmout">
<h3><a class="toc-backref" href="#toc-entry-7">4.3&nbsp;&nbsp;&nbsp;Control LED by PwmOut</a></h3>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<ol class="arabic">
<li><p class="first">Connect the B_L4S5I_IOT01A to the picoscope</p>
<p>In this configuration, B_L4S5I_IOT01A will read an analog signal and convert it to a PWM signal again
to an output pin. We will observe the output pin with both picoscope and a LED.</p>
<ol class="arabic">
<li><p class="first">Connect the picoscope to your computer. <a class="reference external" href="labs/img/Analog_Input/1_1_2.jpg">Screenshot</a></p>
</li>
<li><p class="first">Connect the first probe to the <span class="hl">Channel A</span> <a class="reference external" href="labs/img/Analog_Input/1_1_3.jpg">like this</a>.</p>
</li>
<li><p class="first">Connect the second probe to the port <span class="hl">AWG</span> of picoscope <a class="reference external" href="labs/img/Analog_Input/3_1_4.jpg">like this</a></p>
</li>
<li><p class="first">Connect the first probe to the pin of <span class="hl">D6</span> and the second to the pin of <span class="hl">A0</span> . <a class="reference external" href="labs/img/Analog_Input/B_L4S5I_IOT01A_A0_D6_LED.jpg">Screenshot</a></p>
<img alt="circuit" src="labs/img/Analog_Input/3_2_LED_PWM_A0_D6_new1.jpg" />
</li>
</ol>
</li>
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>4_2_LED_PWM</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">PwmOut</span><span class="w"> </span><span class="nf">PWM1</span><span class="p">(</span><span class="n">D6</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="n">AnalogIn</span><span class="w"> </span><span class="nf">Ain</span><span class="p">(</span><span class="n">A0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 6</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">      </span><span class="n">PWM1</span><span class="p">.</span><span class="n">period_ms</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span><span class="w">      </span><span class="n">PWM1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ain</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">PWM1</span><span class="p">.</span><span class="n">read</span><span class="p">());</span><span class="w"></span>
<span class="linenos">12</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">50</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and run the program</p>
</li>
<li><p class="first">Switch to the picoscope app</p>
</li>
<li><p class="first">Setup picoscope to generate a sine wave</p>
<ol class="arabic">
<li><p class="first">Select &quot;input range A&quot; as <span class="hl">+-5</span> and collection time as <span class="hl">200 ms/div</span>:
<a class="reference external" href="labs/img/Analog_Input/4_2_1.jpg">screenshot</a></p>
</li>
<li><p class="first">Generate the analog signal.</p>
<p>Please choose <span class="hl">sine wave</span> as a demo: <a class="reference external" href="labs/img/Analog_Input/4_2_2.jpg">screenshot</a></p>
</li>
</ol>
</li>
<li><p class="first">The Output terminal will show the analog input voltage values every 50ms: <a class="reference external" href="labs/img/Analog_Input/4_2_4.jpg">like this</a>.</p>
</li>
<li><p class="first">Screenshot your result on the terminal.</p>
</li>
<li><p class="first">The PWM signal will shows on the <a class="reference external" href="labs/img/Analog_Input/4_2_3.jpg">monitor</a>.</p>
</li>
<li><p class="first">Observe the light of LED. It will be like a <span class="hl">breathing led</span>.</p>
</li>
<li><p class="first">Screenshot your result of picoscope.</p>
</li>
</ol>
</div>
<div class="section" id="analogin-with-fft-analysis">
<h3><a class="toc-backref" href="#toc-entry-8">4.4&nbsp;&nbsp;&nbsp;AnalogIn with FFT analysis</a></h3>
<div class="section" id="connect-circuit">
<h4><a class="toc-backref" href="#toc-entry-9">4.4.1&nbsp;&nbsp;&nbsp;Connect circuit</a></h4>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<ol class="arabic">
<li><p class="first">Connect the B_L4S5I_IOT01A to the picoscope</p>
<p>In this configuration, B_L4S5I_IOT01A will read an analog signal and convert it back to analog signal again
to an output pin. We will observe the output pin with both picoscope and a LED.</p>
<ol class="arabic">
<li><p class="first">Connect the picoscope to your computer. <a class="reference external" href="labs/img/Analog_Input/1_1_2.jpg">Screenshot</a></p>
</li>
<li><p class="first">Connect the first probe to the <span class="hl">Channel A</span> <a class="reference external" href="labs/img/Analog_Input/1_1_3.jpg">like this</a>.</p>
</li>
<li><p class="first">Connect the second probe to the port <span class="hl">AWG</span> of picoscope <a class="reference external" href="labs/img/Analog_Input/3_1_4.jpg">like this</a></p>
</li>
<li><p class="first">Connect the first probe to the pin of <span class="hl">D7</span> and the second to the pin of <span class="hl">A0</span> . <a class="reference external" href="labs/img/Analog_Input/B_L4S5I_IOT01A_A0_D7_LED.jpg">Screenshot</a></p>
<img alt="circuit" src="labs/img/Analog_Input/3_1_LED_Analog_A0_D7_new1.jpg" />
</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="new-mbed-program">
<h4><a class="toc-backref" href="#toc-entry-10">4.4.2&nbsp;&nbsp;&nbsp;New Mbed program</a></h4>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>4_4_FFT_analysis</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">AnalogOut</span><span class="w"> </span><span class="nf">Aout</span><span class="p">(</span><span class="n">D7</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="n">AnalogIn</span><span class="w"> </span><span class="nf">Ain</span><span class="p">(</span><span class="n">A0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 7</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">float</span><span class="w"> </span><span class="n">ADCdata</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sample</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="n">Aout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ain</span><span class="p">;</span><span class="w"></span>
<span class="linenos">14</span><span class="w">    </span><span class="n">ADCdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ain</span><span class="p">;</span><span class="w"></span>
<span class="linenos">15</span><span class="w">    </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1000</span><span class="n">ms</span><span class="o">/</span><span class="n">sample</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">17</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sample</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ADCdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">100</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">21</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and flash the program.</p>
</li>
<li><p class="first">Please quit Mbed Studio, so it does not use the serial port of the B_L4S5I_IOT01A.</p>
</li>
</ol>
</div>
<div class="section" id="setup-picoscope">
<h4><a class="toc-backref" href="#toc-entry-11">4.4.3&nbsp;&nbsp;&nbsp;Setup Picoscope</a></h4>
<ol class="arabic">
<li><p class="first">Start the picoscope</p>
</li>
<li><p class="first">Setup picoscope to generate a sine wave</p>
<ol class="arabic">
<li><p class="first">Select &quot;input range A&quot; as <span class="hl">+-5</span> and collection time as <span class="hl">1 s/div</span>:
<a class="reference external" href="labs/img/Analog_Input/3_2_1.png">screenshot</a></p>
</li>
<li><p class="first">Generate the <a class="reference external" href="labs/img/Analog_Input/3_1_2.png">analog signal</a>.</p>
<p>Please choose <span class="hl">sine wave</span>, start frequency <span class="hl">30 Hz</span> and set offset to 1V: <a class="reference external" href="labs/img/Analog_Input/FFT_30HZ.png">screenshot</a></p>
</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="install-python-packages">
<h4><a class="toc-backref" href="#toc-entry-12">4.4.4&nbsp;&nbsp;&nbsp;Install Python packages</a></h4>
<ol class="arabic">
<li><p class="first">Start a Terminal app in Mac OS or Git Bash in Windows.</p>
</li>
<li><p class="first">Install matplotlib</p>
<ol class="arabic simple">
<li><code class="cmd-host">$ python3 -m pip install -U matplotlib</code></li>
</ol>
<p>For Windows, please replace <code class="cmd-host">python3</code> with <code class="cmd-host">python.exe</code>, if you installed Python from www.python.org.
If you use MinGW's Python, the command is the same.
Also, for Python installed from www.python.org, please check that in Window Path environment variable,
Path &quot;C:\msys64\mingw64\bin.&quot; should be set after &quot;C:\Users\&lt;your user name&gt;\AppData\Local\Programs\Python\Python310\&quot;
in order to use the Windows Python in Git Bash.</p>
<p>If the installation gives warning about PATH, please add and modify PATH environment variable according to your OS.</p>
</li>
<li><p class="first">Install PySerial</p>
<ol class="arabic simple">
<li><code class="cmd-host">$ python3 -m pip install pyserial</code></li>
</ol>
<p>If the installation gives warning about PATH, please add and modify PATH environment variable according to your OS.</p>
</li>
<li><p class="first">Copy the following codes into FFT.py in VS code and save the script to <span class="file">~/Mbed Programs/4_4_FFT_analysis</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 3</span><span class="kn">import</span> <span class="nn">serial</span>
<span class="linenos"> 4</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="n">Fs</span> <span class="o">=</span> <span class="mf">128.0</span><span class="p">;</span>  <span class="c1"># sampling rate</span>
<span class="linenos"> 7</span><span class="n">Ts</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Fs</span><span class="p">;</span> <span class="c1"># sampling interval</span>
<span class="linenos"> 8</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Ts</span><span class="p">)</span> <span class="c1"># time vector; create Fs samples between 0 and 1.0 sec.</span>
<span class="linenos"> 9</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Ts</span><span class="p">)</span> <span class="c1"># signal vector; create Fs samples</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="c1"># length of the signal</span>
<span class="linenos">12</span><span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">13</span><span class="n">T</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="n">Fs</span>
<span class="linenos">14</span><span class="n">frq</span> <span class="o">=</span> <span class="n">k</span><span class="o">/</span><span class="n">T</span> <span class="c1"># a vector of frequencies; two sides frequency range</span>
<span class="linenos">15</span><span class="n">frq</span> <span class="o">=</span> <span class="n">frq</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span> <span class="c1"># one side frequency range</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="n">serdev</span> <span class="o">=</span> <span class="s1">&#39;/dev/ttyACM0&#39;</span>
<span class="linenos">18</span><span class="n">s</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">serdev</span><span class="p">)</span>
<span class="linenos">19</span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Fs</span><span class="p">)):</span>
<span class="linenos">20</span>    <span class="n">line</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c1"># Read an echo string from B_L4S5I_IOT01A terminated with &#39;\n&#39;</span>
<span class="linenos">21</span>    <span class="c1"># print line</span>
<span class="linenos">22</span>    <span class="n">y</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># fft computing and normalization</span>
<span class="linenos">25</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span> <span class="c1"># remove the conjugate frequency parts</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">28</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">29</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="linenos">30</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">)</span>
<span class="linenos">31</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frq</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="c1"># plotting the spectrum</span>
<span class="linenos">32</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Freq (Hz)&#39;</span><span class="p">)</span>
<span class="linenos">33</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|Y(freq)|&#39;</span><span class="p">)</span>
<span class="linenos">34</span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="linenos">35</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</li>
<li><p class="first">Replace &quot;serdev&quot; in above FFT.py created by your Operating System.
Go to a Terminal app or Git Bash in Windows.</p>
<p>Use the following command to find the device name of the mbed USB serial connection.</p>
<ol class="arabic">
<li><p class="first"><code class="cmd-host">$ python3 -m serial.tools.list_ports -v</code></p>
<p>In general, lookup for &quot;STM&quot; or &quot;STLink&quot;.</p>
<p>In Windows, you may get the following message. The <strong>COM3</strong> is the device name.</p>
<pre class="terminal literal-block">
1 ports found
COM3
    desc: STMicroelectronics STLink Virtual COM Port (COM3)
    hwid: USB VID:PID=0483:374B SER=0671FF3134354D5043094618 LOCATION=1-3.2:x.2
</pre>
<p>In Mac OS, you may get the following message (there are many other devices). The <strong>/dev/cu.usbmodem14603</strong> is the device name.</p>
<pre class="terminal literal-block">
/dev/cu.usbmodem14603
    desc: STM32 STLink - ST-Link VCP Data
    hwid: USB VID:PID=0483:374B SER=0671FF3134354D5043094618 LOCATION=20-6
</pre>
</li>
</ol>
</li>
<li><p class="first">Execute above Python script in a Terminal app in Mac OS or Git Bash in Windows.</p>
<ol class="arabic simple">
<li><code class="cmd-host">$ cd ~/Mbed\ Programs/4_4_FFT_analysis</code></li>
<li><code class="cmd-host">$ python3 FFT.py</code></li>
</ol>
</li>
<li><p class="first">Please push the &quot;Reset&quot; button on B_L4S5I_IOT01A to start the mbed program again.
Also make sure Picoscope is generating a sine wave signal.</p>
</li>
<li><p class="first">The result will be <a class="reference external" href="labs/img/Analog_Input/FFT_30_result.png">like this</a></p>
</li>
<li><p class="first">Generate another signal with other frequency.</p>
<ol class="arabic">
<li><p class="first">Generate the <a class="reference external" href="labs/img/Analog_Input/3_1_2.png">analog signal</a>.</p>
<p>Please choose <span class="hl">sine wave</span>, start frequency <span class="hl">10 Hz</span> and set offset to 1V: <a class="reference external" href="labs/img/Analog_Input/FFT_10HZ.png">screenshot</a></p>
</li>
</ol>
</li>
<li><p class="first">Re-execute the Python script, the result will <a class="reference external" href="labs/img/Analog_Input/FFT_10_result.png">like this</a></p>
</li>
<li><p class="first">Save the plot of python code.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="measure-the-conversion-timing">
<h3><a class="toc-backref" href="#toc-entry-13">4.5&nbsp;&nbsp;&nbsp;Measure the conversion timing</a></h3>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<ol class="arabic">
<li><p class="first">Connect the B_L4S5I_IOT01A to the picoscope</p>
<ol class="arabic">
<li><p class="first">Connect the picoscope to your computer. <a class="reference external" href="labs/img/Analog_Input/1_1_2.jpg">Screenshot</a></p>
</li>
<li><p class="first">Connect the first probe to the <span class="hl">Channel A</span> <a class="reference external" href="labs/img/Analog_Input/1_1_3.jpg">like this</a>.</p>
</li>
<li><p class="first">Connect the second probe to the port <span class="hl">AWG</span> of picoscope <a class="reference external" href="labs/img/Analog_Input/3_1_4.jpg">like this</a></p>
</li>
<li><p class="first">Connect the first probe to the pin of <span class="hl">D7</span> and the second to the pin of <span class="hl">A0</span> . <a class="reference external" href="labs/img/Analog_Input/B_L4S5I_IOT01A_A0_D7.jpg">Screenshot</a></p>
<img alt="circuit" src="labs/img/Analog_Input/3_5_Exploring_Nyquist_A0_D7_new.jpg" />
</li>
</ol>
</li>
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>4_5_Exploring_Nyquist</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">AnalogOut</span><span class="w"> </span><span class="nf">Aout</span><span class="p">(</span><span class="n">D7</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="n">AnalogIn</span><span class="w"> </span><span class="nf">Ain</span><span class="p">(</span><span class="n">A0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span><span class="kt">float</span><span class="w"> </span><span class="n">ADCdata</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">ADCdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ain</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">    </span><span class="n">Aout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADCdata</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">2</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">13</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and run the program</p>
</li>
<li><p class="first">Switch to the picoscope</p>
</li>
<li><p class="first">Setup picoscope to generate a square wave</p>
<ol class="arabic">
<li><p class="first">Select &quot;input range A&quot; as <span class="hl">+-5</span> and collection time as <span class="hl">1 s/div</span>:
<a class="reference external" href="labs/img/Analog_Input/3_2_1.png">screenshot</a></p>
</li>
<li><p class="first">Generate the <a class="reference external" href="labs/img/Analog_Input/3_1_2.png">analog signal</a>.</p>
<p>Please choose <span class="hl">sine wave</span>, set Start Frequency to <span class="hl">1 HZ</span> and set offset to 1V. <a class="reference external" href="labs/img/Analog_Input/3_4_4.png">Screenshot</a></p>
</li>
</ol>
</li>
<li><p class="first">Change the sampling rate and observe the difference between each wave</p>
<div class="warning docutils container">
<p>If the sampling frequency is less than the twice of signal frequecy (The signal frequency is 1 Hz), the signal may not be sampled completely.
Compare the difference of the following results.</p>
</div>
<ol class="arabic">
<li><p class="first">To set sampling frequency, you need to change the wait time.</p>
<div class="highlight"><pre><span></span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">2</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Wait time = 2 s, sampling frequency = 0.5 Hz. <a class="reference external" href="labs/img/Analog_Input/wait1.png">Screenshot</a></p>
</li>
<li><p class="first">Wait time = 200 ms, sampling frequency = 5 Hz. <a class="reference external" href="labs/img/Analog_Input/wait01.png">Screenshot</a></p>
</li>
<li><p class="first">Wait time = 20 ms, sampling frequency = 50 Hz. <a class="reference external" href="labs/img/Analog_Input/wait001.png">Screenshot</a></p>
</li>
<li><p class="first">Wait time = 2 ms, sampling frequency = 500 Hz. <a class="reference external" href="labs/img/Analog_Input/wait0001.png">Screenshot</a></p>
</li>
</ol>
</li>
<li><p class="first">Screenshot your result of picoscope.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="demo-and-checkpoints">
<h2><a class="toc-backref" href="#toc-entry-14">5&nbsp;&nbsp;&nbsp;Demo and Checkpoints</a></h2>
<ol class="arabic simple">
<li>Show your git remote repository.</li>
<li>Demo the breathing LED.</li>
<li>Show all the results you recorded above.</li>
</ol>
</div>
<div class="section" id="reference-list">
<h2><a class="toc-backref" href="#toc-entry-15">6&nbsp;&nbsp;&nbsp;Reference List</a></h2>
<ol class="arabic simple">
<li><a class="reference external" href="https://developer.mbed.org/handbook/AnalogIn">Introduction of AnalogIn</a></li>
</ol>
</div>

            </div><!-- /.entry-content -->


        </div><!-- /.eleven.columns -->

<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="https://ee2405.github.io/pages/lab-schedule.html">Lab Schedule</a></li>
      <li><a href="https://ee2405.github.io/pages/class-rules.html">Class Rules</a></li>
  </ul>

<h4>Categories</h4>
<ul class="blank">
		<li><a href="https://ee2405.github.io/category/homework.html">homework</a></li>
		<li><a href="https://ee2405.github.io/category/labs.html">labs</a></li>
		<li><a href="https://ee2405.github.io/category/misc.html">misc</a></li>
		<li><a href="https://ee2405.github.io/category/tutorial.html">tutorial</a></li>
</ul>





</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


  <script src="https://ee2405.github.io/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="https://ee2405.github.io/theme/js/libs/gumby.min.js"></script>
  <script src="https://ee2405.github.io/theme/js/plugins.js"></script>
</body>
</html>