<!DOCTYPE html>
<html lang="en">
<head>

        <title>mbed Lab 8 Machine Learning on mbed</title>
        <meta charset="utf-8" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="https://www.ee.nthu.edu.tw/ee240500/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="https://www.ee.nthu.edu.tw/ee240500/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="https://www.ee.nthu.edu.tw/ee240500/theme/pygment.css" />
        <link rel="stylesheet" type="text/css" href="https://www.ee.nthu.edu.tw/ee240500/theme/LARC.css" />

 
        <script src="https://www.ee.nthu.edu.tw/ee240500/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="https://www.ee.nthu.edu.tw/ee240500/">Embedded System Lab <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="https://www.ee.nthu.edu.tw/ee240500/">Home</a></li>

                <li><a href="https://www.ee.nthu.edu.tw/ee240500/pages/lab-schedule.html">Lab Schedule</a></li>
                <li><a href="https://www.ee.nthu.edu.tw/ee240500/pages/class-rules.html">Class Rules</a></li>
              <form class="navbar-form navbar-right" role="search" action="https://www.ee.nthu.edu.tw/ee240500/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <div class="form-group">
                  <div class="input-group">
                    <input type="text" name="q" id="tipue_search_input" class="form-control search-query" placeholder="Search" required />
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit"><i class="fa
                          fa-search fa-fw"></i></button>
                    </span>
                  </div>
                </div>
              </form>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="https://www.ee.nthu.edu.tw/ee240500/mbed-lab-8-machine-learning-on-mbed.html" rel="bookmark"
                   title="Permalink to mbed Lab 8 Machine Learning on mbed">mbed Lab 8 Machine Learning on mbed</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2022-03-30T15:00:00+08:00">
                Mar 30, 2022
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="https://www.ee.nthu.edu.tw/ee240500/author/jing-jia-liou.html"> Jing-Jia Liou</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <!-- usage: include:: LARC_def.txt -->
<!-- please check https://github.com/nevir/groc/issues/63#issuecomment-24299684 for pygments' lexer list -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#lab-due" id="id1">1&nbsp;&nbsp;&nbsp;Lab Due</a></li>
<li><a class="reference internal" href="#lab-introduction" id="id2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></li>
<li><a class="reference internal" href="#equipment-list" id="id3">3&nbsp;&nbsp;&nbsp;Equipment List</a></li>
<li><a class="reference internal" href="#deep-learning-introduction" id="id4">4&nbsp;&nbsp;&nbsp;Deep Learning Introduction</a></li>
<li><a class="reference internal" href="#lab-description" id="id5">5&nbsp;&nbsp;&nbsp;Lab Description</a><ul class="auto-toc">
<li><a class="reference internal" href="#lecture-notes" id="id6">5.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></li>
<li><a class="reference internal" href="#data-collection-and-labeling" id="id7">5.2&nbsp;&nbsp;&nbsp;Data Collection and Labeling</a></li>
<li><a class="reference internal" href="#model-training" id="id8">5.3&nbsp;&nbsp;&nbsp;Model Training</a><ul class="auto-toc">
<li><a class="reference internal" href="#create-a-github-repo" id="id9">5.3.1&nbsp;&nbsp;&nbsp;Create a GitHub repo</a></li>
<li><a class="reference internal" href="#modify-the-repo" id="id10">5.3.2&nbsp;&nbsp;&nbsp;Modify the repo</a></li>
<li><a class="reference internal" href="#start-a-colab-script-for-training" id="id11">5.3.3&nbsp;&nbsp;&nbsp;Start a Colab script for training</a></li>
</ul>
</li>
<li><a class="reference internal" href="#model-deployment" id="id12">5.4&nbsp;&nbsp;&nbsp;Model Deployment</a></li>
<li><a class="reference internal" href="#model-deployment-code-reference" id="id13">5.5&nbsp;&nbsp;&nbsp;Model Deployment Code Reference</a></li>
</ul>
</li>
<li><a class="reference internal" href="#demo-and-checkpoints" id="id14">6&nbsp;&nbsp;&nbsp;Demo and Checkpoints</a></li>
<li><a class="reference internal" href="#reference-list" id="id15">7&nbsp;&nbsp;&nbsp;Reference List</a></li>
</ul>
</div>
<div class="tasklist docutils container">
<p>The goal of this lab is to learn:</p>
<ol class="arabic simple">
<li>the flow of a deep learning framework</li>
<li>inference of a trained model on an mbed board</li>
</ol>
</div>
<div class="section" id="lab-due">
<h2><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Lab Due</a></h2>
<p><strong>Mar. 30, 2022</strong></p>
</div>
<div class="section" id="lab-introduction">
<h2><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></h2>
<p>In this lab, we will introduce the workflow of deep learning for gesture
classification on B_L4S5I_IOT01A. The deep learning model is trained and tested
on Google's Colab service with TensorFlow. Then the model will be transferred
to B_L4S5I_IOT01A to perform inference with accelerometer data.</p>
</div>
<div class="section" id="equipment-list">
<h2><a class="toc-backref" href="#id3">3&nbsp;&nbsp;&nbsp;Equipment List</a></h2>
<ol class="arabic simple">
<li>B_L4S5I_IOT01A * 1</li>
</ol>
</div>
<div class="section" id="deep-learning-introduction">
<h2><a class="toc-backref" href="#id4">4&nbsp;&nbsp;&nbsp;Deep Learning Introduction</a></h2>
<p>Deep learning neural network (DNN) algorithm train a model of multi-layer
convolutions to extract features on a large-scale data set (e.g., for images or
speeches).  Several DNN models have been shown to out-perform human. And there
could be several new applications in different domains with DNN such as
autonomous car, manufacturing, agriculture, etc.  Usually, there are 4 phases
in applying DNN algorithm: data collection, data labeling, model training, and
model deployment.</p>
<ol class="arabic simple">
<li>In <span class="file">data collection phase</span>,
we have to collect relevant data for our application.
Normally the quality of collected data has the huge impact on the
performance for the task, and also the amount of data should be large
enough. Otherwise, the model will not be effective.</li>
<li>In <span class="file">data labeling phase</span>, we have to label (tag) the collected data
to denote the class of data. For example, to recognize different kinds of
birds, we need to assign the correct name for each bird photo.</li>
<li>In <span class="file">model training phase</span>, we write a DNN model (usually in Python)
and feed the collected data (with labels) to a DNN framework (TensorFlow)
to train the model. Usually part of the data set is used as test data
(to test the model independently). The remaining data will again be
partitioned into two parts: training set and validation set. The training
set is used to train the model and validation set is used to estimate the
performance. Training and validation sets may be mixed,
e.g., in cross-validation methods.</li>
<li>In <span class="file">model deployment phase</span>, we transfer the trained DNN model
to the machine (B_L4S5I_IOT01A) in actual application environment
for a final test and tuning.</li>
</ol>
<p>Note: the description above is based on the supervised deep learning model,
which means you need to put labeled data to train the model. On the other hand,
using non-labeled data to train the model is unsupervised deep learning model
(e.g., clustering).</p>
<p><strong>In this lab, you will collect accelerometer data and prepare data for training
a classifier for gestures. And the model will be deployed on B_L4S5I_IOT01A.</strong></p>
</div>
<div class="section" id="lab-description">
<h2><a class="toc-backref" href="#id5">5&nbsp;&nbsp;&nbsp;Lab Description</a></h2>
<div class="section" id="lecture-notes">
<h3><a class="toc-backref" href="#id6">5.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></h3>
<ul class="simple">
<li>Chapter 9: Deep Neural Networks <a class="reference external" href="notes/ch9_dnn.pdf">ch9_dnn.pdf</a></li>
</ul>
</div>
<div class="section" id="data-collection-and-labeling">
<h3><a class="toc-backref" href="#id7">5.2&nbsp;&nbsp;&nbsp;Data Collection and Labeling</a></h3>
<div class="instruct docutils container">
You may skip this part the first time you do this lab.
We have prepared two gestures' data and you can start the training process
in the Colab (next section) to get familar with the overall process.</div>
<div class="instruct docutils container">
<p>The purpose of this data collection is to get a sequence of accelerometer data
that are generated from similar gestures. We will put the data in a text format
(&quot;gesture_&lt;label&gt;.txt&quot;), which will be eventually copied to &quot;data/raw/gesture_&lt;label&gt;.txt&quot; in the DNN
training directory to be uploaded to your GitHub repo.</p>
<p>To use the following code to collect data, it is recommended that you record each
gesture at least 200 times. As for <strong>negative</strong> category of label, you
should collect the gestures that don't belong to the other labels.</p>
<p>We have collected a few labeled data for your reference:
<a class="reference external" href="labs/doc/ML_on_K66F/gesture_ring.txt">gesture_ring.txt</a>,
<a class="reference external" href="labs/doc/ML_on_K66F/gesture_slope.txt">gesture_slope.txt</a>,
and <a class="reference external" href="labs/doc/ML_on_K66F/gesture_negative.txt">gesture_negative.txt</a>.
(You don't need to download them here, since we will copy from another remote repo
in the next section.)</p>
<p>The ring gesture is like <a class="reference external" href="labs/img/ML_on_K66F/gesture_ring.png">this</a>,
and the slope gesture is like <a class="reference external" href="labs/img/ML_on_K66F/gesture_slope.png">this</a>.</p>
</div>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>8_1_data_collect</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Import BSP library for running accelerometer.</p>
<div class="instruct docutils container">
<p>The imported BSP (Board Support Package) library has drivers for STMicro B_L4S5I_IOT01A boards,
which enable access to its sensors. In this part, we use the accelerometers. You are encouraged to
try other sensors. Please refer to <a class="reference external" href="https://os.mbed.com/teams/ST/code/DISCO_L475VG_IOT01-Sensors-BSP//file/f49325f1e644/main.cpp/">DISCO_L475VG_IOT01-Sensors-BSP</a> for more examples.</p>
</div>
<ol class="arabic simple">
<li>Click <strong>+</strong> in the Library tab under program source.</li>
<li>Fill in <cite>https://gitlab.larc-nthu.net/ee2405_2022/bsp-b-l475e-iot01.git</cite>
And click &quot;Next&quot;</li>
<li>Select &quot;main&quot; branch and click &quot;Finish&quot;</li>
<li>Delete the following file:
<span class="file">bsp-b-l475e-iot01/Drivers/BSP/B-L475E-IOT01/stm32l475e_iot01_qspi.*</span>
&quot;*&quot; means any file extension.</li>
</ol>
</li>
<li><p class="first">mbed B_L4S5I_IOT01A part:</p>
<ol class="arabic">
<li><p class="first">Edit <span class="file">main.cpp</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#include</span> <span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="lineno"> 2 </span><span class="cp">#include</span> <span class="cpf">&quot;stm32l475e_iot01_accelero.h&quot;</span><span class="cp"></span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="n">InterruptIn</span> <span class="nf">btnRecord</span><span class="p">(</span><span class="n">BUTTON1</span><span class="p">);</span>
<span class="lineno"> 5 </span><span class="n">EventQueue</span> <span class="nf">queue</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">EVENTS_EVENT_SIZE</span><span class="p">);</span>
<span class="lineno"> 6 </span><span class="n">Thread</span> <span class="n">t</span><span class="p">;</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="kt">int16_t</span> <span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="lineno"> 9 </span><span class="kt">int</span> <span class="n">idR</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="lineno">10 </span><span class="kt">int</span> <span class="n">indexR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="kt">void</span> <span class="nf">record</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">13 </span>   <span class="n">BSP_ACCELERO_AccGetXYZ</span><span class="p">(</span><span class="n">pDataXYZ</span><span class="p">);</span>
<span class="lineno">14 </span>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="lineno">15 </span><span class="p">}</span>
<span class="lineno">16 </span>
<span class="lineno">17 </span><span class="kt">void</span> <span class="nf">startRecord</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">18 </span>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;---start---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">19 </span>   <span class="n">idR</span><span class="p">[</span><span class="n">indexR</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">call_every</span><span class="p">(</span><span class="mi">1</span><span class="n">ms</span><span class="p">,</span> <span class="n">record</span><span class="p">);</span>
<span class="lineno">20 </span>   <span class="n">indexR</span> <span class="o">=</span> <span class="n">indexR</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
<span class="lineno">21 </span><span class="p">}</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="kt">void</span> <span class="nf">stopRecord</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">24 </span>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;---stop---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">25 </span>   <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">i</span> <span class="p">:</span> <span class="n">idR</span><span class="p">)</span>
<span class="lineno">26 </span>      <span class="n">queue</span><span class="p">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="lineno">27 </span><span class="p">}</span>
<span class="lineno">28 </span>
<span class="lineno">29 </span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">30 </span>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Start accelerometer init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">31 </span>   <span class="n">BSP_ACCELERO_Init</span><span class="p">();</span>
<span class="lineno">32 </span>   <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EventQueue</span><span class="o">::</span><span class="n">dispatch_forever</span><span class="p">));</span>
<span class="lineno">33 </span>   <span class="n">btnRecord</span><span class="p">.</span><span class="n">fall</span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="n">event</span><span class="p">(</span><span class="n">startRecord</span><span class="p">));</span>
<span class="lineno">34 </span>   <span class="n">btnRecord</span><span class="p">.</span><span class="n">rise</span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="n">event</span><span class="p">(</span><span class="n">stopRecord</span><span class="p">));</span>
<span class="lineno">35 </span><span class="p">}</span>
</pre></div>
</li>
<li><p class="first">Compile and run the program.</p>
</li>
<li><p class="first">If the accelerometer values are appearing on the outputs when you press and hold USER button, release the User button
to stop the measurement. This would show that the program works.</p>
</li>
<li><p class="first">Quit Mbed Studio, since we will use Python to collect the data from the same UART port.</p>
</li>
</ol>
</li>
<li><p class="first">Python program to collect data from mbed:</p>
<ol class="arabic">
<li><p class="first">Edit <span class="file">data_collect.py</span>.
Replace the following &quot;serdev&quot; with your UART device in your OS (i.e. COM7 or /dev/cu.usbmodem14603).</p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">import</span> <span class="nn">serial</span>
<span class="lineno"> 2 </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno"> 3 </span><span class="kn">import</span> <span class="nn">time</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="n">serdev</span> <span class="o">=</span> <span class="s1">&#39;/dev/ttyACM0&#39;</span>
<span class="lineno"> 6 </span><span class="n">s</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">serdev</span><span class="p">)</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 9 </span><span class="n">data_new</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">10 </span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="lineno">11 </span>  <span class="k">try</span><span class="p">:</span>
<span class="lineno">12 </span>    <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="lineno">13 </span>    <span class="k">if</span> <span class="s1">&#39;---start---&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<span class="lineno">14 </span>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---start---&quot;</span><span class="p">)</span>
<span class="lineno">15 </span>      <span class="n">data_new</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="lineno">16 </span>    <span class="k">elif</span> <span class="s1">&#39;---stop---&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<span class="lineno">17 </span>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---stop---&quot;</span><span class="p">)</span>
<span class="lineno">18 </span>      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_new</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">19 </span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data saved:&quot;</span><span class="p">)</span>
<span class="lineno">20 </span>        <span class="nb">print</span><span class="p">(</span><span class="n">data_new</span><span class="p">)</span>
<span class="lineno">21 </span>        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_new</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="lineno">22 </span>        <span class="n">data_new</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="lineno">23 </span>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Num =&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="lineno">24 </span>    <span class="k">else</span><span class="p">:</span>
<span class="lineno">25 </span>      <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="lineno">26 </span>      <span class="n">data_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="lineno">27 </span>  <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<span class="lineno">28 </span>    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;gesture_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;.txt&quot;</span>
<span class="lineno">29 </span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="lineno">30 </span>      <span class="k">for</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="lineno">31 </span>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;-,-,-</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="lineno">32 </span>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<span class="lineno">33 </span>          <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="lineno">34 </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting...&quot;</span><span class="p">)</span>
<span class="lineno">35 </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Save file in&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="lineno">36 </span>    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="lineno">37 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</li>
</ol>
</li>
<li><p class="first">Start a Terminal app and go to the directory for the <span class="file">data_collect.py</span>.
For example,</p>
<p><code class="cmd-host">$ cd &quot;Mbed Programs&quot;/8_1_data_collect</code></p>
</li>
<li><p class="first">Execute the python script</p>
<p><code class="cmd-host">$ python3 data_collect.py</code></p>
<p>Note that this program only works in a Terminal. Do not run this program in VS Code.</p>
</li>
<li><p class="first">Press and hold the USER Button on mbed to record the gesture.</p>
</li>
<li><p class="first">Release the USER button to stop recording.
If you release USER Button but the it is still recording, just press the USER_BUTTON
several times until it stops.</p>
</li>
<li><p class="first">Press 'Ctrl + C' in terminal to terminate the program, and the program will give
you a text file starting with <span class="file">gesture_</span>.</p>
</li>
<li><p class="first">Rename the file to <span class="file">gesture_&lt;label&gt;.txt</span>. In next section, we will copy it to folder
<span class="file">mbed08/data/raw</span>.</p>
<p>Note: <span class="file">&lt;time&gt;</span> is like <span class="file">202004081520</span>;
<span class="file">&lt;label&gt;</span> is like <span class="file">ring</span>.</p>
</li>
<li><p class="first">Push your codes to a GitHub repo.</p>
</li>
</ol>
</div>
<div class="section" id="model-training">
<h3><a class="toc-backref" href="#id8">5.3&nbsp;&nbsp;&nbsp;Model Training</a></h3>
<p>In this part, we will feed the labeled data to train a model that classifies
gesture. We will use the data collected in the previous parts (for the first run,
you may use our collected data sets) in <a class="reference external" href="https://colab.research.google.com/#">Google Colab</a>.</p>
<div class="section" id="create-a-github-repo">
<h4><a class="toc-backref" href="#id9">5.3.1&nbsp;&nbsp;&nbsp;Create a GitHub repo</a></h4>
<ol class="arabic">
<li><p class="first">Please login github.com with your account.</p>
</li>
<li><p class="first">Select &quot;Import repository&quot; (with the <strong>+</strong> at top-right besides your profile).</p>
<ol class="arabic simple">
<li>Fill in URL: &quot;<a class="reference external" href="https://gitlab.larc-nthu.net/ee2405_2022/gesture-dnn.git">https://gitlab.larc-nthu.net/ee2405_2022/gesture-dnn.git</a>&quot;.</li>
<li>Fill in &quot;mbed08&quot; as the repo name.</li>
<li>Set the repo as a &quot;Public&quot; repo.</li>
</ol>
<p>After the importing completed, you will have a repo at &quot;<a class="reference external" href="mailto:git&#64;github.com">git&#64;github.com</a>:&lt;Your Git ID&gt;/mbed08.git&quot;.
Replace above &lt;Your Git ID&gt; with your GitHub ID or copy from GitHub &quot;Code&quot; tab.
It will includes all source codes and example data for DNN training.
For the first time to run the flow, you may skip the following step to proceed to Colab training.</p>
</li>
</ol>
</div>
<div class="section" id="modify-the-repo">
<h4><a class="toc-backref" href="#id10">5.3.2&nbsp;&nbsp;&nbsp;Modify the repo</a></h4>
<p>Please skip this step for the first run to get familiar of the flow.</p>
<p>In the following, we show how to clone/modify/push the repo to add more gesture data.
Assume we want to add <span class="file">gesture_new.txt</span> and modify <span class="file">config.py</span> to include the new
gesture data in the following.</p>
<ol class="arabic">
<li><p class="first">Start a Terminal app or a Git Bash in Windows.</p>
<p><code class="cmd-host">$ cd ~/Mbed\ Programs</code></p>
<p><code class="cmd-host">$ git clone git&#64;github.com:&lt;Your Git ID&gt;/mbed08.git</code></p>
<p>Now we have cloned the mbed08 repo at <span class="file">~/MbedPrograms/mbed08</span> locally.</p>
</li>
<li><p class="first">Copy <span class="file">gesture_new.txt</span> into <span class="file">~/MbedPrograms/mbed08/data/raw</span></p>
<p>You may use Finder or File Explorer for this. In the following, we show a command line:</p>
<p><code class="cmd-host">$ cp ~/Mbed\ Programs/8_1_data_collect/gesture_new.txt ~/Mbed\ Programs/mbed08/data/raw</code></p>
</li>
<li><p class="first">Edit <span class="file">config.py</span></p>
<p>You may use Finder or File Explorer for this. In the following, we show a command line:</p>
<p><code class="cmd-host">$ code ~/Mbed\ Programs/mbed08/src/model_train/config.py</code></p>
<p>Change the line with &quot;labels =  [&quot;ring&quot;, &quot;slope&quot;, &quot;negative&quot;]&quot;.
For example, &quot;labels =  [&quot;ring&quot;, &quot;slope&quot;, &quot;new&quot;, &quot;negative&quot;]&quot;.</p>
<div class="instruct docutils container">
<p>You can tune some parameters in the <span class="file">config.py</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="n">DATA_NAME</span> <span class="o">=</span> <span class="s2">&quot;accel_ms2_xyz&quot;</span>
<span class="lineno"> 2 </span><span class="n">LABEL_NAME</span> <span class="o">=</span> <span class="s2">&quot;gesture&quot;</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># label name (you should keep &quot;negative&quot; in the end of the list)</span>
<span class="lineno"> 5 </span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ring&quot;</span><span class="p">,</span> <span class="s2">&quot;slope&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">]</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="c1"># data split configuration</span>
<span class="lineno"> 8 </span><span class="c1"># note that train_ratio + valid_ratio + test_ratio = 1</span>
<span class="lineno"> 9 </span><span class="n">train_ratio</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="lineno">10 </span><span class="n">valid_ratio</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="lineno">11 </span><span class="n">data_split_random_seed</span> <span class="o">=</span> <span class="mi">30</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span><span class="c1"># model configuration</span>
<span class="lineno">14 </span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;CNN&quot;</span>
<span class="lineno">15 </span><span class="n">seq_length</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1"># the input size of the model</span>
<span class="lineno">16 </span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">50</span>
<span class="lineno">17 </span><span class="n">steps_per_epoch</span> <span class="o">=</span><span class="mi">1000</span>
<span class="lineno">18 </span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
</pre></div>
</div>
</li>
<li><p class="first">In a Terminal, push new <span class="file">gesture_new.txt</span> and modified <span class="file">config.py</span> to your GitHub mbed08.</p>
<p><code class="cmd-host">$ cd ~/Mbed\ Programs/mbed08</code></p>
<p><code class="cmd-host">$ git add data/raw/gesture_new.txt</code></p>
<p><code class="cmd-host">$ git add src/model_train/config.py</code></p>
<p><code class="cmd-host">$ git commit -m &quot;add new training gesture&quot;</code></p>
<p><code class="cmd-host">$ git push</code></p>
<p>Please go to GitHub.com to double check if the files are updated.
If so, you may proceed to the Colab training part.</p>
</li>
</ol>
</div>
<div class="section" id="start-a-colab-script-for-training">
<h4><a class="toc-backref" href="#id11">5.3.3&nbsp;&nbsp;&nbsp;Start a Colab script for training</a></h4>
<ol class="arabic">
<li><p class="first">Open <span class="hl">https://colab.research.google.com/github/&lt;Your Git ID&gt;/mbed08/blob/master/src/model_train/train_magic_wand_model.ipynb</span> in the browser.</p>
<p>Replace <span class="file">&lt;Your Git ID&gt;</span> is your GitHub user name.</p>
</li>
<li><p class="first">Fill in <span class="file">&quot;REPO_URL&quot;</span> and <span class="file">&quot;REPO_NAME&quot;</span> in the first box at Google Colab to your github name and repo.</p>
<div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REPO_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/ee2405/mbed08.git&quot;</span>
<span class="lineno">2 </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REPO_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mbed08&quot;</span>
</pre></div>
</li>
<li><p class="first">Press the play button beside each of the cell to run the code in each cell of colab.</p>
</li>
<li><p class="first">Copy and save from the last box for the following part.
It should looks like the following texts:</p>
<pre class="terminal literal-block">
unsigned char _content_mbed08_model_model_tflite[] = {
  0x1c, 0x00, 0x00, 0x00, 0x54, 0x46, 0x4c, 0x33, 0x14, 0x00, 0x20, 0x00,
  0x04, 0x00, 0x08, 0x00, 0x0c, 0x00, 0x10, 0x00, 0x14, 0x00, 0x00, 0x00,
  0x18, 0x00, 0x1c, 0x00, 0x14, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
  ...
};
unsigned int _content_mbed08_model_model_tflite_len = 12988;
</pre>
</li>
</ol>
</div>
</div>
<div class="section" id="model-deployment">
<h3><a class="toc-backref" href="#id12">5.4&nbsp;&nbsp;&nbsp;Model Deployment</a></h3>
<p>Following steps are meant to obtain a quantized version of NN that will be
deployable on an Arm Cortex-M microcontroller.  In the training above, the data
type is 32-bit floating point, but FP operation is inefficient on an embedded
system, so wee will quantize the weight to 8-bit integer and generate C++ files
that contains the inference of the network.</p>
<p>Now we create a new Mbed program and add a Tensorflow Lite library for inferencing. (BSP library is also needed)</p>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>8_2_model_deploy</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy all .cpp and .h files from <a class="reference external" href="https://gitlab.larc-nthu.net/ee2405_2022/code-example/-/tree/master/mbed%20Lab%2008%20Machine%20Learning%20on%20mbed/8_2%20Model%20Deploy">https://gitlab.larc-nthu.net/ee2405_2022/code-example/-/tree/master/mbed%20Lab%2008%20Machine%20Learning%20on%20mbed/8_2%20Model%20Deploy</a> into the 8_2_model_deploy folder.
You may use drag and drop from Finder or File Explorer.</p>
</li>
<li><p class="first">Import BSP library for getting accelerometer values.</p>
<ol class="arabic simple">
<li>Click <strong>+</strong> in the Library tab under program source.</li>
<li>Fill in <cite>http://developer.mbed.org/teams/ST/code/BSP_B-L475E-IOT01/</cite>
And click &quot;Next&quot;</li>
<li>Select &quot;default&quot; branch and click &quot;Finish&quot;</li>
<li>Delete the following file:
<span class="file">BSP_B-L475E-IOT01/Drivers/BSP/B-L475E-IOT01/stm32l475e_iot01_qspi.*</span>
&quot;*&quot; means any file extension.</li>
</ol>
</li>
<li><p class="first">Import Tensorflow Lite library.</p>
<ol class="arabic simple">
<li>Click <strong>+</strong> in the Library tab under program source.</li>
<li>Fill in <cite>https://gitlab.larc-nthu.net/ee2405_2021/tensorflowlite_mbed</cite>
And click &quot;Next&quot;</li>
<li>Select &quot;Master&quot; branch and click &quot;Finish&quot;</li>
</ol>
</li>
<li><p class="first">Edit <span class="file">magic_wand_model_data.cpp</span> and fill in the blank according to the trained parameter data from the Google Colab.</p>
<ol class="arabic simple">
<li>Change &quot;g_magic_wand_model_data[]&quot; array and &quot;model_tflite_len&quot;.</li>
</ol>
<div class="highlight"><pre><span></span>unsigned int model_tflite_len = ;// Fill the int in `src/model.cc` here
</pre></div>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#include</span> <span class="cpf">&quot;magic_wand_model_data.h&quot;</span><span class="cp"></span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c1">// We need to keep the data array aligned on some architectures.</span>
<span class="lineno"> 4 </span><span class="cp">#ifdef __has_attribute</span>
<span class="lineno"> 5 </span><span class="cp">#define HAVE_ATTRIBUTE(x) __has_attribute(x)</span>
<span class="lineno"> 6 </span><span class="cp">#else</span>
<span class="lineno"> 7 </span><span class="cp">#define HAVE_ATTRIBUTE(x) 0</span>
<span class="lineno"> 8 </span><span class="cp">#endif</span>
<span class="lineno"> 9 </span><span class="cp">#if HAVE_ATTRIBUTE(aligned) || (defined(__GNUC__) &amp;&amp; !defined(__clang__))</span>
<span class="lineno">10 </span><span class="cp">#define DATA_ALIGN_ATTRIBUTE __attribute__((aligned(4)))</span>
<span class="lineno">11 </span><span class="cp">#else</span>
<span class="lineno">12 </span><span class="cp">#define DATA_ALIGN_ATTRIBUTE</span>
<span class="lineno">13 </span><span class="cp">#endif</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g_magic_wand_model_data</span><span class="p">[]</span> <span class="n">DATA_ALIGN_ATTRIBUTE</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">16 </span>  <span class="c1">// Paste the data of the char array in `src/model.cc` here</span>
<span class="lineno">17 </span><span class="p">};</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">model_tflite_len</span> <span class="o">=</span> <span class="p">;</span><span class="c1">// Fill the int in `src/model.cc` here</span>
</pre></div>
</li>
<li><p class="first">Edit <span class="file">config_tflite.h</span></p>
<ol class="arabic simple">
<li>Change label_num to fit your gesture number, e.g., 3.</li>
</ol>
<div class="highlight"><pre><span></span><span class="cp">#define label_num 2</span>
</pre></div>
<ol class="arabic simple">
<li>Revise the output_message[] data array to fit your new gesture.</li>
</ol>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#ifndef CONFIG_H_</span>
<span class="lineno"> 2 </span><span class="cp">#define CONFIG_H_</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1">// The number of labels (without negative)</span>
<span class="lineno"> 5 </span><span class="cp">#define label_num 2</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="k">struct</span> <span class="n">Config</span> <span class="p">{</span>
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span>  <span class="c1">// This must be the same as seq_length in the src/model_train/config.py</span>
<span class="lineno">10 </span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">seq_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span>  <span class="c1">// The number of expected consecutive inferences for each gesture type.</span>
<span class="lineno">13 </span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">consecutiveInferenceThresholds</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">output_message</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">16 </span>        <span class="s">&quot;RING:</span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">17 </span>        <span class="s">&quot;          *       </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">18 </span>        <span class="s">&quot;       *     *    </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">19 </span>        <span class="s">&quot;     *         *  </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">20 </span>        <span class="s">&quot;    *           * </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">21 </span>        <span class="s">&quot;     *         *  </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">22 </span>        <span class="s">&quot;       *     *    </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">23 </span>        <span class="s">&quot;          *       </span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span>
<span class="lineno">24 </span>        <span class="s">&quot;SLOPE:</span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">25 </span>        <span class="s">&quot;        *        </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">26 </span>        <span class="s">&quot;       *         </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">27 </span>        <span class="s">&quot;      *          </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">28 </span>        <span class="s">&quot;     *           </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">29 </span>        <span class="s">&quot;    *            </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">30 </span>        <span class="s">&quot;   *             </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">31 </span>        <span class="s">&quot;  *              </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">32 </span>        <span class="s">&quot; * * * * * * * * </span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">};</span>
<span class="lineno">33 </span><span class="p">};</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="n">Config</span> <span class="n">config_tflite</span><span class="p">;</span>
<span class="lineno">36 </span><span class="cp">#endif </span><span class="c1">// CONFIG_H_</span>
</pre></div>
</li>
<li><p class="first">Compile and run the program to test with the DNN inference with your board by waving different gestures.</p>
</li>
<li><p class="first">Push the code to your GitHub repo.</p>
</li>
</ol>
</div>
<div class="section" id="model-deployment-code-reference">
<h3><a class="toc-backref" href="#id13">5.5&nbsp;&nbsp;&nbsp;Model Deployment Code Reference</a></h3>
<ol class="arabic">
<li><p class="first"><span class="file">main.cpp</span></p>
<div class="highlight"><pre><span></span><span class="lineno">  1 </span><span class="cp">#include</span> <span class="cpf">&quot;accelerometer_handler.h&quot;</span><span class="cp"></span>
<span class="lineno">  2 </span><span class="cp">#include</span> <span class="cpf">&quot;config_tflite.h&quot;</span><span class="cp"></span>
<span class="lineno">  3 </span><span class="cp">#include</span> <span class="cpf">&quot;magic_wand_model_data.h&quot;</span><span class="cp"></span>
<span class="lineno">  4 </span>
<span class="lineno">  5 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/c/common.h&quot;</span><span class="cp"></span>
<span class="lineno">  6 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/micro/kernels/micro_ops.h&quot;</span><span class="cp"></span>
<span class="lineno">  7 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/micro/micro_error_reporter.h&quot;</span><span class="cp"></span>
<span class="lineno">  8 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/micro/micro_interpreter.h&quot;</span><span class="cp"></span>
<span class="lineno">  9 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/micro/micro_mutable_op_resolver.h&quot;</span><span class="cp"></span>
<span class="lineno"> 10 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/schema/schema_generated.h&quot;</span><span class="cp"></span>
<span class="lineno"> 11 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/version.h&quot;</span><span class="cp"></span>
<span class="lineno"> 12 </span>
<span class="lineno"> 13 </span><span class="c1">// Create an area of memory to use for input, output, and intermediate arrays.</span>
<span class="lineno"> 14 </span><span class="c1">// The size of this will depend on the model you&#39;re using, and may need to be</span>
<span class="lineno"> 15 </span><span class="c1">// determined by experimentation.</span>
<span class="lineno"> 16 </span><span class="k">constexpr</span> <span class="kt">int</span> <span class="n">kTensorArenaSize</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="lineno"> 17 </span><span class="kt">uint8_t</span> <span class="n">tensor_arena</span><span class="p">[</span><span class="n">kTensorArenaSize</span><span class="p">];</span>
<span class="lineno"> 18 </span>
<span class="lineno"> 19 </span><span class="c1">// Return the result of the last prediction</span>
<span class="lineno"> 20 </span><span class="kt">int</span> <span class="nf">PredictGesture</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 21 </span>  <span class="c1">// How many times the most recent gesture has been matched in a row</span>
<span class="lineno"> 22 </span>  <span class="k">static</span> <span class="kt">int</span> <span class="n">continuous_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 23 </span>  <span class="c1">// The result of the last prediction</span>
<span class="lineno"> 24 </span>  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_predict</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 25 </span>
<span class="lineno"> 26 </span>  <span class="c1">// Find whichever output has a probability &gt; 0.8 (they sum to 1)</span>
<span class="lineno"> 27 </span>  <span class="kt">int</span> <span class="n">this_predict</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 28 </span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">label_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 29 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">)</span> <span class="n">this_predict</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="lineno"> 30 </span>  <span class="p">}</span>
<span class="lineno"> 31 </span>
<span class="lineno"> 32 </span>  <span class="c1">// No gesture was detected above the threshold</span>
<span class="lineno"> 33 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">this_predict</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 34 </span>    <span class="n">continuous_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 35 </span>    <span class="n">last_predict</span> <span class="o">=</span> <span class="n">label_num</span><span class="p">;</span>
<span class="lineno"> 36 </span>    <span class="k">return</span> <span class="n">label_num</span><span class="p">;</span>
<span class="lineno"> 37 </span>  <span class="p">}</span>
<span class="lineno"> 38 </span>
<span class="lineno"> 39 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">last_predict</span> <span class="o">==</span> <span class="n">this_predict</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 40 </span>    <span class="n">continuous_count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 41 </span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 42 </span>    <span class="n">continuous_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 43 </span>  <span class="p">}</span>
<span class="lineno"> 44 </span>  <span class="n">last_predict</span> <span class="o">=</span> <span class="n">this_predict</span><span class="p">;</span>
<span class="lineno"> 45 </span>
<span class="lineno"> 46 </span>  <span class="c1">// If we haven&#39;t yet had enough consecutive matches for this gesture,</span>
<span class="lineno"> 47 </span>  <span class="c1">// report a negative result</span>
<span class="lineno"> 48 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">continuous_count</span> <span class="o">&lt;</span> <span class="n">config_tflite</span><span class="p">.</span><span class="n">consecutiveInferenceThresholds</span><span class="p">[</span><span class="n">this_predict</span><span class="p">])</span> <span class="p">{</span>
<span class="lineno"> 49 </span>    <span class="k">return</span> <span class="n">label_num</span><span class="p">;</span>
<span class="lineno"> 50 </span>  <span class="p">}</span>
<span class="lineno"> 51 </span>  <span class="c1">// Otherwise, we&#39;ve seen a positive result, so clear all our variables</span>
<span class="lineno"> 52 </span>  <span class="c1">// and report it</span>
<span class="lineno"> 53 </span>  <span class="n">continuous_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 54 </span>  <span class="n">last_predict</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 55 </span>
<span class="lineno"> 56 </span>  <span class="k">return</span> <span class="n">this_predict</span><span class="p">;</span>
<span class="lineno"> 57 </span><span class="p">}</span>
<span class="lineno"> 58 </span>
<span class="lineno"> 59 </span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="lineno"> 60 </span>
<span class="lineno"> 61 </span>  <span class="c1">// Whether we should clear the buffer next time we fetch data</span>
<span class="lineno"> 62 </span>  <span class="kt">bool</span> <span class="n">should_clear_buffer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 63 </span>  <span class="kt">bool</span> <span class="n">got_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno"> 64 </span>
<span class="lineno"> 65 </span>  <span class="c1">// The gesture index of the prediction</span>
<span class="lineno"> 66 </span>  <span class="kt">int</span> <span class="n">gesture_index</span><span class="p">;</span>
<span class="lineno"> 67 </span>
<span class="lineno"> 68 </span>  <span class="c1">// Set up logging.</span>
<span class="lineno"> 69 </span>  <span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroErrorReporter</span> <span class="n">micro_error_reporter</span><span class="p">;</span>
<span class="lineno"> 70 </span>  <span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">micro_error_reporter</span><span class="p">;</span>
<span class="lineno"> 71 </span>
<span class="lineno"> 72 </span>  <span class="c1">// Map the model into a usable data structure. This doesn&#39;t involve any</span>
<span class="lineno"> 73 </span>  <span class="c1">// copying or parsing, it&#39;s a very lightweight operation.</span>
<span class="lineno"> 74 </span>  <span class="k">const</span> <span class="n">tflite</span><span class="o">::</span><span class="n">Model</span><span class="o">*</span> <span class="n">model</span> <span class="o">=</span> <span class="n">tflite</span><span class="o">::</span><span class="n">GetModel</span><span class="p">(</span><span class="n">g_magic_wand_model_data</span><span class="p">);</span>
<span class="lineno"> 75 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">()</span> <span class="o">!=</span> <span class="n">TFLITE_SCHEMA_VERSION</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 76 </span>    <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span>
<span class="lineno"> 77 </span>        <span class="s">&quot;Model provided is schema version %d not equal &quot;</span>
<span class="lineno"> 78 </span>        <span class="s">&quot;to supported version %d.&quot;</span><span class="p">,</span>
<span class="lineno"> 79 </span>        <span class="n">model</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">(),</span> <span class="n">TFLITE_SCHEMA_VERSION</span><span class="p">);</span>
<span class="lineno"> 80 </span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno"> 81 </span>  <span class="p">}</span>
<span class="lineno"> 82 </span>
<span class="lineno"> 83 </span>  <span class="c1">// Pull in only the operation implementations we need.</span>
<span class="lineno"> 84 </span>  <span class="c1">// This relies on a complete list of all the ops needed by this graph.</span>
<span class="lineno"> 85 </span>  <span class="c1">// An easier approach is to just use the AllOpsResolver, but this will</span>
<span class="lineno"> 86 </span>  <span class="c1">// incur some penalty in code space for op implementations that are not</span>
<span class="lineno"> 87 </span>  <span class="c1">// needed by this graph.</span>
<span class="lineno"> 88 </span>  <span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroOpResolver</span><span class="o">&lt;</span><span class="mi">6</span><span class="o">&gt;</span> <span class="n">micro_op_resolver</span><span class="p">;</span>
<span class="lineno"> 89 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span>
<span class="lineno"> 90 </span>      <span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_DEPTHWISE_CONV_2D</span><span class="p">,</span>
<span class="lineno"> 91 </span>      <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_DEPTHWISE_CONV_2D</span><span class="p">());</span>
<span class="lineno"> 92 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_MAX_POOL_2D</span><span class="p">,</span>
<span class="lineno"> 93 </span>                               <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_MAX_POOL_2D</span><span class="p">());</span>
<span class="lineno"> 94 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_CONV_2D</span><span class="p">,</span>
<span class="lineno"> 95 </span>                               <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_CONV_2D</span><span class="p">());</span>
<span class="lineno"> 96 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_FULLY_CONNECTED</span><span class="p">,</span>
<span class="lineno"> 97 </span>                               <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_FULLY_CONNECTED</span><span class="p">());</span>
<span class="lineno"> 98 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_SOFTMAX</span><span class="p">,</span>
<span class="lineno"> 99 </span>                               <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_SOFTMAX</span><span class="p">());</span>
<span class="lineno">100 </span>  <span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_RESHAPE</span><span class="p">,</span>
<span class="lineno">101 </span>                               <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_RESHAPE</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="lineno">102 </span>
<span class="lineno">103 </span>  <span class="c1">// Build an interpreter to run the model with</span>
<span class="lineno">104 </span>  <span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroInterpreter</span> <span class="n">static_interpreter</span><span class="p">(</span>
<span class="lineno">105 </span>      <span class="n">model</span><span class="p">,</span> <span class="n">micro_op_resolver</span><span class="p">,</span> <span class="n">tensor_arena</span><span class="p">,</span> <span class="n">kTensorArenaSize</span><span class="p">,</span> <span class="n">error_reporter</span><span class="p">);</span>
<span class="lineno">106 </span>  <span class="n">tflite</span><span class="o">::</span><span class="n">MicroInterpreter</span><span class="o">*</span> <span class="n">interpreter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">static_interpreter</span><span class="p">;</span>
<span class="lineno">107 </span>
<span class="lineno">108 </span>  <span class="c1">// Allocate memory from the tensor_arena for the model&#39;s tensors</span>
<span class="lineno">109 </span>  <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">AllocateTensors</span><span class="p">();</span>
<span class="lineno">110 </span>
<span class="lineno">111 </span>  <span class="c1">// Obtain pointer to the model&#39;s input tensor</span>
<span class="lineno">112 </span>  <span class="n">TfLiteTensor</span><span class="o">*</span> <span class="n">model_input</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="lineno">113 </span>  <span class="k">if</span> <span class="p">((</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
<span class="lineno">114 </span>      <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config_tflite</span><span class="p">.</span><span class="n">seq_length</span><span class="p">)</span> <span class="o">||</span>
<span class="lineno">115 </span>      <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kChannelNumber</span><span class="p">)</span> <span class="o">||</span>
<span class="lineno">116 </span>      <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">kTfLiteFloat32</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">117 </span>    <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Bad input tensor parameters in model&quot;</span><span class="p">);</span>
<span class="lineno">118 </span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">119 </span>  <span class="p">}</span>
<span class="lineno">120 </span>
<span class="lineno">121 </span>  <span class="kt">int</span> <span class="n">input_length</span> <span class="o">=</span> <span class="n">model_input</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<span class="lineno">122 </span>
<span class="lineno">123 </span>  <span class="n">TfLiteStatus</span> <span class="n">setup_status</span> <span class="o">=</span> <span class="n">SetupAccelerometer</span><span class="p">(</span><span class="n">error_reporter</span><span class="p">);</span>
<span class="lineno">124 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">setup_status</span> <span class="o">!=</span> <span class="n">kTfLiteOk</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">125 </span>    <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Set up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">126 </span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">127 </span>  <span class="p">}</span>
<span class="lineno">128 </span>
<span class="lineno">129 </span>  <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Set up successful...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">130 </span>
<span class="lineno">131 </span>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">132 </span>
<span class="lineno">133 </span>    <span class="c1">// Attempt to read new data from the accelerometer</span>
<span class="lineno">134 </span>    <span class="n">got_data</span> <span class="o">=</span> <span class="n">ReadAccelerometer</span><span class="p">(</span><span class="n">error_reporter</span><span class="p">,</span> <span class="n">model_input</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">,</span>
<span class="lineno">135 </span>                                 <span class="n">input_length</span><span class="p">,</span> <span class="n">should_clear_buffer</span><span class="p">);</span>
<span class="lineno">136 </span>
<span class="lineno">137 </span>    <span class="c1">// If there was no new data,</span>
<span class="lineno">138 </span>    <span class="c1">// don&#39;t try to clear the buffer again and wait until next time</span>
<span class="lineno">139 </span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">got_data</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">140 </span>      <span class="n">should_clear_buffer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">141 </span>      <span class="k">continue</span><span class="p">;</span>
<span class="lineno">142 </span>    <span class="p">}</span>
<span class="lineno">143 </span>
<span class="lineno">144 </span>    <span class="c1">// Run inference, and report any error</span>
<span class="lineno">145 </span>    <span class="n">TfLiteStatus</span> <span class="n">invoke_status</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">Invoke</span><span class="p">();</span>
<span class="lineno">146 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">invoke_status</span> <span class="o">!=</span> <span class="n">kTfLiteOk</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">147 </span>      <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Invoke failed on index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">begin_index</span><span class="p">);</span>
<span class="lineno">148 </span>      <span class="k">continue</span><span class="p">;</span>
<span class="lineno">149 </span>    <span class="p">}</span>
<span class="lineno">150 </span>
<span class="lineno">151 </span>    <span class="c1">// Analyze the results to obtain a prediction</span>
<span class="lineno">152 </span>    <span class="n">gesture_index</span> <span class="o">=</span> <span class="n">PredictGesture</span><span class="p">(</span><span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">);</span>
<span class="lineno">153 </span>
<span class="lineno">154 </span>    <span class="c1">// Clear the buffer next time we read data</span>
<span class="lineno">155 </span>    <span class="n">should_clear_buffer</span> <span class="o">=</span> <span class="n">gesture_index</span> <span class="o">&lt;</span> <span class="n">label_num</span><span class="p">;</span>
<span class="lineno">156 </span>
<span class="lineno">157 </span>    <span class="c1">// Produce an output</span>
<span class="lineno">158 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">gesture_index</span> <span class="o">&lt;</span> <span class="n">label_num</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">159 </span>      <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="n">config_tflite</span><span class="p">.</span><span class="n">output_message</span><span class="p">[</span><span class="n">gesture_index</span><span class="p">]);</span>
<span class="lineno">160 </span>    <span class="p">}</span>
<span class="lineno">161 </span>  <span class="p">}</span>
<span class="lineno">162 </span><span class="p">}</span>
</pre></div>
</li>
<li><p class="first"><span class="file">accelerometer_handler.h</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#ifndef ACCELEROMETER_HANDLER_H_</span>
<span class="lineno"> 2 </span><span class="cp">#define ACCELEROMETER_HANDLER_H_</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="cp">#define kChannelNumber 3</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/c/common.h&quot;</span><span class="cp"></span>
<span class="lineno"> 7 </span><span class="cp">#include</span> <span class="cpf">&quot;tensorflow/lite/micro/micro_error_reporter.h&quot;</span><span class="cp"></span>
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span><span class="k">extern</span> <span class="kt">int</span> <span class="n">begin_index</span><span class="p">;</span>
<span class="lineno">10 </span><span class="k">extern</span> <span class="n">TfLiteStatus</span> <span class="nf">SetupAccelerometer</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span><span class="p">);</span>
<span class="lineno">11 </span><span class="k">extern</span> <span class="kt">bool</span> <span class="nf">ReadAccelerometer</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span><span class="p">,</span>
<span class="lineno">12 </span>                              <span class="kt">float</span><span class="o">*</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">reset_buffer</span><span class="p">);</span>
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="cp">#endif  </span><span class="c1">// ACCELEROMETER_HANDLER_H_</span>
</pre></div>
</li>
<li><p class="first"><span class="file">accelerometer_handler.cpp</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#include</span> <span class="cpf">&quot;accelerometer_handler.h&quot;</span><span class="cp"></span>
<span class="lineno"> 2 </span><span class="cp">#include</span> <span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="lineno"> 3 </span><span class="cp">#include</span> <span class="cpf">&quot;stm32l475e_iot01_accelero.h&quot;</span><span class="cp"></span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="c1">// Store x, y, z data</span>
<span class="lineno"> 6 </span><span class="kt">int16_t</span> <span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1">// A buffer holding the last 200 sets of 3-channel values</span>
<span class="lineno"> 9 </span><span class="k">static</span> <span class="kt">float</span> <span class="n">save_data</span><span class="p">[</span><span class="mi">600</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">};</span>
<span class="lineno">10 </span><span class="c1">// Most recent position in the save_data buffer</span>
<span class="lineno">11 </span><span class="kt">int</span> <span class="n">begin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">12 </span><span class="c1">// True if there is not yet enough data to run inference</span>
<span class="lineno">13 </span><span class="kt">bool</span> <span class="n">pending_initial_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">14 </span><span class="c1">// How often we should save a measurement during downsampling</span>
<span class="lineno">15 </span><span class="kt">int</span> <span class="n">sample_every_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">16 </span><span class="c1">// The number of measurements since we last saved one</span>
<span class="lineno">17 </span><span class="kt">int</span> <span class="n">sample_skip_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="n">TfLiteStatus</span> <span class="nf">SetupAccelerometer</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">20 </span>  <span class="c1">// Init accelerometer</span>
<span class="lineno">21 </span>  <span class="n">BSP_ACCELERO_Init</span><span class="p">();</span>
<span class="lineno">22 </span>  <span class="k">return</span> <span class="n">kTfLiteOk</span><span class="p">;</span>
<span class="lineno">23 </span><span class="p">}</span>
<span class="lineno">24 </span>
<span class="lineno">25 </span><span class="kt">bool</span> <span class="nf">ReadAccelerometer</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">input</span><span class="p">,</span>
<span class="lineno">26 </span>                       <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">reset_buffer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">27 </span>  <span class="c1">// Clear the buffer if required, e.g. after a successful prediction</span>
<span class="lineno">28 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">reset_buffer</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">29 </span>    <span class="n">memset</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="lineno">30 </span>    <span class="n">begin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">31 </span>    <span class="n">pending_initial_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">32 </span>  <span class="p">}</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span>  <span class="c1">// Obtain a sample</span>
<span class="lineno">35 </span>  <span class="k">while</span><span class="p">(</span><span class="n">sample_skip_counter</span> <span class="o">&lt;=</span> <span class="n">sample_every_n</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">36 </span>     <span class="n">BSP_ACCELERO_AccGetXYZ</span><span class="p">(</span><span class="n">pDataXYZ</span><span class="p">);</span>
<span class="lineno">37 </span>     <span class="n">sample_skip_counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">38 </span>  <span class="p">}</span>
<span class="lineno">39 </span>
<span class="lineno">40 </span>  <span class="c1">// Write samples to our buffer, converting to milli-Gs</span>
<span class="lineno">41 </span>  <span class="n">save_data</span><span class="p">[</span><span class="n">begin_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno">42 </span>  <span class="n">save_data</span><span class="p">[</span><span class="n">begin_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno">43 </span>  <span class="n">save_data</span><span class="p">[</span><span class="n">begin_index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pDataXYZ</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno">44 </span>
<span class="lineno">45 </span>  <span class="c1">// Since we took a sample, reset the skip counter</span>
<span class="lineno">46 </span>  <span class="n">sample_skip_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">47 </span>
<span class="lineno">48 </span>  <span class="c1">// If we reached the end of the circle buffer, reset</span>
<span class="lineno">49 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">begin_index</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">50 </span>    <span class="n">begin_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">51 </span>  <span class="p">}</span>
<span class="lineno">52 </span>
<span class="lineno">53 </span>  <span class="c1">// Check if we are ready for prediction or still pending more initial data</span>
<span class="lineno">54 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">pending_initial_data</span> <span class="o">&amp;&amp;</span> <span class="n">begin_index</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">55 </span>    <span class="n">pending_initial_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">56 </span>  <span class="p">}</span>
<span class="lineno">57 </span>
<span class="lineno">58 </span>  <span class="c1">// Return if we don&#39;t have enough data</span>
<span class="lineno">59 </span>  <span class="k">if</span> <span class="p">(</span><span class="n">pending_initial_data</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">60 </span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="lineno">61 </span>  <span class="p">}</span>
<span class="lineno">62 </span>
<span class="lineno">63 </span>  <span class="c1">// Copy the requested number of bytes to the provided input tensor</span>
<span class="lineno">64 </span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">65 </span>    <span class="kt">int</span> <span class="n">ring_array_index</span> <span class="o">=</span> <span class="n">begin_index</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">length</span><span class="p">;</span>
<span class="lineno">66 </span>    <span class="k">if</span> <span class="p">(</span><span class="n">ring_array_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">67 </span>      <span class="n">ring_array_index</span> <span class="o">+=</span> <span class="mi">600</span><span class="p">;</span>
<span class="lineno">68 </span>    <span class="p">}</span>
<span class="lineno">69 </span>    <span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_data</span><span class="p">[</span><span class="n">ring_array_index</span><span class="p">];</span>
<span class="lineno">70 </span>  <span class="p">}</span>
<span class="lineno">71 </span>
<span class="lineno">72 </span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="lineno">73 </span><span class="p">}</span>
</pre></div>
</li>
<li><p class="first"><span class="file">magic_wand_model_data.h</span></p>
<div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="cp">#ifndef MAGIC_WAND_MODEL_DATA_H_</span>
<span class="lineno">2 </span><span class="cp">#define MAGIC_WAND_MODEL_DATA_H_</span>
<span class="lineno">3 </span>
<span class="lineno">4 </span><span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g_magic_wand_model_data</span><span class="p">[];</span>
<span class="lineno">5 </span><span class="k">extern</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">g_magic_wand_model_data_len</span><span class="p">;</span>
<span class="lineno">6 </span>
<span class="lineno">7 </span><span class="cp">#endif  </span><span class="c1">// MAGIC_WAND_MODEL_DATA_H_</span>
</pre></div>
</li>
<li><p class="first"><span class="file">magic_wand_model_data.cpp</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#include</span> <span class="cpf">&quot;magic_wand_model_data.h&quot;</span><span class="cp"></span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="c1">// We need to keep the data array aligned on some architectures.</span>
<span class="lineno"> 4 </span><span class="cp">#ifdef __has_attribute</span>
<span class="lineno"> 5 </span><span class="cp">#define HAVE_ATTRIBUTE(x) __has_attribute(x)</span>
<span class="lineno"> 6 </span><span class="cp">#else</span>
<span class="lineno"> 7 </span><span class="cp">#define HAVE_ATTRIBUTE(x) 0</span>
<span class="lineno"> 8 </span><span class="cp">#endif</span>
<span class="lineno"> 9 </span><span class="cp">#if HAVE_ATTRIBUTE(aligned) || (defined(__GNUC__) &amp;&amp; !defined(__clang__))</span>
<span class="lineno">10 </span><span class="cp">#define DATA_ALIGN_ATTRIBUTE __attribute__((aligned(4)))</span>
<span class="lineno">11 </span><span class="cp">#else</span>
<span class="lineno">12 </span><span class="cp">#define DATA_ALIGN_ATTRIBUTE</span>
<span class="lineno">13 </span><span class="cp">#endif</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g_magic_wand_model_data</span><span class="p">[]</span> <span class="n">DATA_ALIGN_ATTRIBUTE</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">16 </span>  <span class="c1">// Paste the data of the char array in `src/model.cc` here</span>
<span class="lineno">17 </span><span class="p">};</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">model_tflite_len</span> <span class="o">=</span> <span class="p">;</span><span class="c1">// Fill the int in `src/model.cc` here</span>
</pre></div>
</li>
<li><p class="first">Add and edit <span class="file">config_tflite.h</span></p>
<div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="cp">#ifndef CONFIG_H_</span>
<span class="lineno"> 2 </span><span class="cp">#define CONFIG_H_</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1">// The number of labels (without negative)</span>
<span class="lineno"> 5 </span><span class="cp">#define label_num 2</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="k">struct</span> <span class="n">Config</span> <span class="p">{</span>
<span class="lineno"> 8 </span>
<span class="lineno"> 9 </span>  <span class="c1">// This must be the same as seq_length in the src/model_train/config.py</span>
<span class="lineno">10 </span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">seq_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span>  <span class="c1">// The number of expected consecutive inferences for each gesture type.</span>
<span class="lineno">13 </span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">consecutiveInferenceThresholds</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">output_message</span><span class="p">[</span><span class="n">label_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">16 </span>        <span class="s">&quot;RING:</span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">17 </span>        <span class="s">&quot;          *       </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">18 </span>        <span class="s">&quot;       *     *    </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">19 </span>        <span class="s">&quot;     *         *  </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">20 </span>        <span class="s">&quot;    *           * </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">21 </span>        <span class="s">&quot;     *         *  </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">22 </span>        <span class="s">&quot;       *     *    </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">23 </span>        <span class="s">&quot;          *       </span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span>
<span class="lineno">24 </span>        <span class="s">&quot;SLOPE:</span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">25 </span>        <span class="s">&quot;        *        </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">26 </span>        <span class="s">&quot;       *         </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">27 </span>        <span class="s">&quot;      *          </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">28 </span>        <span class="s">&quot;     *           </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">29 </span>        <span class="s">&quot;    *            </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">30 </span>        <span class="s">&quot;   *             </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">31 </span>        <span class="s">&quot;  *              </span><span class="se">\n\r</span><span class="s">&quot;</span>
<span class="lineno">32 </span>        <span class="s">&quot; * * * * * * * * </span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">};</span>
<span class="lineno">33 </span><span class="p">};</span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="n">Config</span> <span class="n">config_tflite</span><span class="p">;</span>
<span class="lineno">36 </span><span class="cp">#endif </span><span class="c1">// CONFIG_H_</span>
</pre></div>
</li>
<li><p class="first">TensorFlow Lite functions:</p>
<ol class="arabic">
<li><p class="first">Logging Method</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroErrorReporter</span> <span class="n">micro_error_reporter</span><span class="p">;</span>
<span class="n">tflite</span><span class="o">::</span><span class="n">ErrorReporter</span><span class="o">*</span> <span class="n">error_reporter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">micro_error_reporter</span><span class="p">;</span>
<span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</pre></div>
<p>The implement method is similar to the code below but it will preprocess the variable you give it before printed.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">DebugLog</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</li>
<li><p class="first">Load a model</p>
<p>Load a model from char array.</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">tflite</span><span class="o">::</span><span class="n">Model</span><span class="o">*</span> <span class="n">model</span> <span class="o">=</span> <span class="n">tflite</span><span class="o">::</span><span class="n">GetModel</span><span class="p">(</span><span class="n">g_magic_wand_model_data</span><span class="p">);</span>
</pre></div>
</li>
<li><p class="first">Operations resolver</p>
<p>This will be used by the interpreter to access the operations.</p>
<p>To figure out the operations that provided by TensorFlow Lite,
please check
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/micro/kernels/all_ops_resolver.cc">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/micro/kernels/all_ops_resolver.cc</a></p>
<div class="highlight"><pre><span></span><span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">AllOpsResolver</span> <span class="n">micro_op_resolver</span><span class="p">;</span>
</pre></div>
<ol class="arabic">
<li><p class="first">Just load the operation implementations we need</p>
<p>The AllOpsResolver loads all of the operations available in TensorFlow
Lite for Microcontrollers, which uses a lot of memory. Since a given
model will only use a subset of these operations, it's recommended
that real world applications load only the operations that are needed.</p>
<p>To load the operation implementations we need, use the method below
instead.</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroOpResolver</span><span class="o">&lt;</span><span class="n">op_num</span><span class="o">&gt;</span> <span class="n">micro_op_resolver</span><span class="p">;</span>
<span class="n">micro_op_resolver</span><span class="p">.</span><span class="n">AddBuiltin</span><span class="p">(</span><span class="n">tflite</span><span class="o">::</span><span class="n">BuiltinOperator_OP_NAME</span><span class="p">,</span> <span class="n">tflite</span><span class="o">::</span><span class="n">ops</span><span class="o">::</span><span class="n">micro</span><span class="o">::</span><span class="n">Register_OP_NAME</span><span class="p">());</span>
</pre></div>
</li>
</ol>
</li>
<li><p class="first">Interpreter</p>
<ol class="arabic">
<li><p class="first">Allocate memory</p>
<p>We need to preallocate some of memory for input, output, and
intermediate arrays.</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">tensor_arena_size</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">tensor_arena</span><span class="p">[</span><span class="n">tensor_arena_size</span><span class="p">];</span>
</pre></div>
</li>
<li><p class="first">Build the interpreter</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">tflite</span><span class="o">::</span><span class="n">MicroInterpreter</span> <span class="n">static_interpreter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">micro_op_resolver</span><span class="p">,</span> <span class="n">tensor_arena</span><span class="p">,</span> <span class="n">kTensorArenaSize</span><span class="p">,</span> <span class="n">error_reporter</span><span class="p">);</span>
<span class="n">tflite</span><span class="o">::</span><span class="n">MicroInterpreter</span><span class="o">*</span> <span class="n">interpreter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">static_interpreter</span><span class="p">;</span>
</pre></div>
</li>
<li><p class="first">Allocate tensors</p>
<div class="highlight"><pre><span></span><span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">AllocateTensors</span><span class="p">();</span>
</pre></div>
</li>
<li><p class="first">Get the pointer to model input</p>
<div class="highlight"><pre><span></span><span class="n">TfLiteTensor</span><span class="o">*</span> <span class="n">model_input</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</li>
<li><p class="first">Validate input shape</p>
<p>You can modify the condition to match your model.</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">((</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config_tflite</span><span class="p">.</span><span class="n">seq_length</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">dims</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kChannelNumber</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">kTfLiteFloat32</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Bad input tensor parameters in model&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</li>
<li><p class="first">Provide an input value</p>
<div class="highlight"><pre><span></span><span class="n">model_input</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</pre></div>
<p>In this lab, we use a function to provide an input value.</p>
<div class="highlight"><pre><span></span><span class="n">got_data</span> <span class="o">=</span> <span class="n">ReadAccelerometer</span><span class="p">(</span><span class="n">error_reporter</span><span class="p">,</span> <span class="n">model_input</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">,</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">should_clear_buffer</span><span class="p">);</span>
</pre></div>
</li>
<li><p class="first">Run the model</p>
<div class="highlight"><pre><span></span><span class="n">TfLiteStatus</span> <span class="n">invoke_status</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">Invoke</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">invoke_status</span> <span class="o">!=</span> <span class="n">kTfLiteOk</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">error_reporter</span><span class="o">-&gt;</span><span class="n">Report</span><span class="p">(</span><span class="s">&quot;Invoke failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</li>
<li><p class="first">Obtain the output</p>
<div class="highlight"><pre><span></span><span class="n">TfLiteTensor</span><span class="o">*</span> <span class="n">output</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="n">output</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</pre></div>
<p>In this lab, we use a function to obtain the output value.</p>
<div class="highlight"><pre><span></span><span class="n">gesture_index</span> <span class="o">=</span> <span class="n">PredictGesture</span><span class="p">(</span><span class="n">interpreter</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">f</span><span class="p">);</span>
</pre></div>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div class="section" id="demo-and-checkpoints">
<h2><a class="toc-backref" href="#id14">6&nbsp;&nbsp;&nbsp;Demo and Checkpoints</a></h2>
<ol class="arabic simple">
<li>Show your git remote repository.</li>
<li>Show the result of inference of your gesture (not ring or slope).</li>
</ol>
</div>
<div class="section" id="reference-list">
<h2><a class="toc-backref" href="#id15">7&nbsp;&nbsp;&nbsp;Reference List</a></h2>
<ol class="arabic simple">
<li><a class="reference external" href="https://www.geeksforgeeks.org/how-to-use-google-colab/">How to use Google Colab</a></li>
<li><a class="reference external" href="https://www.tensorflow.org/lite/microcontrollers">TensorFlow Lite for Microcontrollers</a></li>
<li><a class="reference external" href="https://www.tensorflow.org/lite/microcontrollers/get_started">Get started with microcontrollers</a></li>
<li><a class="reference external" href="https://www.tensorflow.org/lite/api_docs/cc">TensorFlow Lite API Reference</a></li>
</ol>
</div>

            </div><!-- /.entry-content -->


        </div><!-- /.eleven.columns -->

<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="https://www.ee.nthu.edu.tw/ee240500/pages/lab-schedule.html">Lab Schedule</a></li>
      <li><a href="https://www.ee.nthu.edu.tw/ee240500/pages/class-rules.html">Class Rules</a></li>
  </ul>

<h4>Categories</h4>
<ul class="blank">
		<li><a href="https://www.ee.nthu.edu.tw/ee240500/category/homework.html">homework</a></li>
		<li><a href="https://www.ee.nthu.edu.tw/ee240500/category/labs.html">labs</a></li>
		<li><a href="https://www.ee.nthu.edu.tw/ee240500/category/misc.html">misc</a></li>
		<li><a href="https://www.ee.nthu.edu.tw/ee240500/category/tutorial.html">tutorial</a></li>
</ul>





</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


  <script src="https://www.ee.nthu.edu.tw/ee240500/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="https://www.ee.nthu.edu.tw/ee240500/theme/js/libs/gumby.min.js"></script>
  <script src="https://www.ee.nthu.edu.tw/ee240500/theme/js/plugins.js"></script>
</body>
</html>