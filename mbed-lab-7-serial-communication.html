<!DOCTYPE html>
<html lang="en">
<head>

        <title>mbed Lab 7 Serial Communication</title>
        <meta charset="utf-8" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/pygment.css" />
        <link rel="stylesheet" type="text/css" href="https://ee2405.github.io/theme/LARC.css" />

 
        <script src="https://ee2405.github.io/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="https://ee2405.github.io/">Embedded System Lab <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="https://ee2405.github.io/">Home</a></li>

                <li><a href="https://ee2405.github.io/pages/lab-schedule.html">Lab Schedule</a></li>
                <li><a href="https://ee2405.github.io/pages/class-rules.html">Class Rules</a></li>
              <form class="navbar-form navbar-right" role="search" action="https://ee2405.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);">
                <div class="form-group">
                  <div class="input-group">
                    <input type="text" name="q" id="tipue_search_input" class="form-control search-query" placeholder="Search" required />
                    <span class="input-group-btn">
                      <button class="btn btn-default" type="submit"><i class="fa
                          fa-search fa-fw"></i></button>
                    </span>
                  </div>
                </div>
              </form>

              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="https://ee2405.github.io/mbed-lab-7-serial-communication.html" rel="bookmark"
                   title="Permalink to mbed Lab 7 Serial Communication">mbed Lab 7 Serial Communication</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2022-03-23T15:00:00+08:00">
                 3 23, 2022
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="https://ee2405.github.io/author/jing-jia-liou.html"> Jing-Jia Liou</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <!-- usage: include:: LARC_def.txt -->
<!-- please check https://github.com/nevir/groc/issues/63#issuecomment-24299684 for pygments' lexer list -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#lab-due" id="toc-entry-1">1&nbsp;&nbsp;&nbsp;Lab Due</a></li>
<li><a class="reference internal" href="#lab-introduction" id="toc-entry-2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></li>
<li><a class="reference internal" href="#equipment-list" id="toc-entry-3">3&nbsp;&nbsp;&nbsp;Equipment List</a></li>
<li><a class="reference internal" href="#lab-description" id="toc-entry-4">4&nbsp;&nbsp;&nbsp;Lab Description</a><ul class="auto-toc">
<li><a class="reference internal" href="#lecture-notes" id="toc-entry-5">4.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></li>
<li><a class="reference internal" href="#mbed-spi-self-loopback" id="toc-entry-6">4.2&nbsp;&nbsp;&nbsp;mbed SPI Self Loopback</a></li>
<li><a class="reference internal" href="#mbed-uart-loopback" id="toc-entry-7">4.3&nbsp;&nbsp;&nbsp;mbed UART loopback</a><ul class="auto-toc">
<li><a class="reference internal" href="#uart-loopback-connection" id="toc-entry-8">4.3.1&nbsp;&nbsp;&nbsp;UART Loopback Connection</a></li>
<li><a class="reference internal" href="#mbed-uart-loopback-program" id="toc-entry-9">4.3.2&nbsp;&nbsp;&nbsp;mbed UART Loopback Program</a></li>
<li><a class="reference internal" href="#picoscope-uart-decoding" id="toc-entry-10">4.3.3&nbsp;&nbsp;&nbsp;Picoscope UART Decoding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-your-own-lcd-library-i2c-version" id="toc-entry-11">4.4&nbsp;&nbsp;&nbsp;Build your own LCD library I2C version</a></li>
<li><a class="reference internal" href="#import-textlcd-library-for-i2c" id="toc-entry-12">4.5&nbsp;&nbsp;&nbsp;Import TextLCD library for I2C</a></li>
<li><a class="reference internal" href="#tmp102-with-i2c" id="toc-entry-13">4.6&nbsp;&nbsp;&nbsp;TMP102 with I2C</a><ul class="auto-toc">
<li><a class="reference internal" href="#connect-to-tmp102-with-i2c" id="toc-entry-14">4.6.1&nbsp;&nbsp;&nbsp;Connect to TMP102 with I2C</a></li>
<li><a class="reference internal" href="#connect-picoscope-to-i2c" id="toc-entry-15">4.6.2&nbsp;&nbsp;&nbsp;Connect Picoscope to I2C</a></li>
<li><a class="reference internal" href="#create-a-program-to-read-tmp102" id="toc-entry-16">4.6.3&nbsp;&nbsp;&nbsp;Create a Program to Read TMP102</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#checkpoints" id="toc-entry-17">5&nbsp;&nbsp;&nbsp;Checkpoints</a></li>
<li><a class="reference internal" href="#reference-list" id="toc-entry-18">6&nbsp;&nbsp;&nbsp;Reference List</a></li>
</ul>
</div>
<div class="tasklist docutils container">
<p>The goal of this lab is to learn:</p>
<ol class="arabic simple">
<li>Use UART to communicate between two boards</li>
<li>Use I2C to get access to slave module</li>
</ol>
</div>
<div class="section" id="lab-due">
<h2><a class="toc-backref" href="#toc-entry-1">1&nbsp;&nbsp;&nbsp;Lab Due</a></h2>
<p><strong>Mar. 23, 2022</strong></p>
</div>
<div class="section" id="lab-introduction">
<h2><a class="toc-backref" href="#toc-entry-2">2&nbsp;&nbsp;&nbsp;Lab Introduction</a></h2>
<p>This lab introduces mbed objects about serial communication: <strong>SPI</strong>,
<strong>BufferedSerial</strong> and <strong>I2C</strong>.  BufferedSerial, usually called UART or RS-232,
is a generic protocol used by computers and electronic modules to send and
receive control information and data. The UART serial link has two uni-directional
asynchronous channels (wires), one for sending and one for receiving. Note that
both ends of the serial links must be configured with the same settings (packet
format and baud rate, etc.).</p>
<p>SPI interface is a synchronous interface (with a MISO, a MOSI, and a clock) to
serially transfer data between a master and a slave device. The transfer is like
connecting two shift registers (of both master and slave): output from a master's
shift register is connected to slave shift register input (MOSI), and also
the slave's shift register output is connected to master's input (MISO). Therefore,
with two data wires and a clock, we can transfer data between master and slave.
SPI can provide a speed of 60M bps for applications.</p>
<p>The I2C interface also provides a synchronous serial channel between masters
and slaves. The I2C has only one data wire and one clock. The data wire will be
used in either write or read mode. The I2C also include an addressing protocol.
I2C usually connects micro-controllers to on-board sensors at low-cost and
low-speed (1-5M bps).</p>
</div>
<div class="section" id="equipment-list">
<h2><a class="toc-backref" href="#toc-entry-3">3&nbsp;&nbsp;&nbsp;Equipment List</a></h2>
<ol class="arabic simple">
<li>B_L4S5I_IOT01A * 1</li>
<li>Breadboard * 1</li>
<li>Picoscope * 1</li>
<li>TextLCD * 1</li>
</ol>
</div>
<div class="section" id="lab-description">
<h2><a class="toc-backref" href="#toc-entry-4">4&nbsp;&nbsp;&nbsp;Lab Description</a></h2>
<div class="section" id="lecture-notes">
<h3><a class="toc-backref" href="#toc-entry-5">4.1&nbsp;&nbsp;&nbsp;Lecture Notes</a></h3>
<ul class="simple">
<li>Chapter 8: Serial Communication <a class="reference external" href="notes/ch8_serial.pdf">ch8_serial.pdf</a></li>
</ul>
</div>
<div class="section" id="mbed-spi-self-loopback">
<h3><a class="toc-backref" href="#toc-entry-6">4.2&nbsp;&nbsp;&nbsp;mbed SPI Self Loopback</a></h3>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<ol class="arabic">
<li><p class="first">Use the following SPI pins to connect loop back between two SPI interfaces on the board.
Note that &quot;PD&quot; pins are at the PMOD connector.</p>
<ol class="arabic">
<li><p class="first">Use SPI1_MOSI(D11)、SPI1_MISO(D12)、SPI1_SCK(D13)、SPI1_CS(D9)、SPI2_MOSI(PD_4)、SPI2_MISO(PD_3)、SPI2_SCK(PD_1)、SPI2_CS(PD_0)</p>
<p>Here is the example about connect SPI to B_L4S5I_IOT01A. <a class="reference external" href="labs/img/Serial_Communication/SPIboard2.jpg">Picture</a></p>
<img alt="loop back SPI connections" src="labs/img/Serial_Communication/SPIboard3.jpg" />
</li>
</ol>
</li>
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>7_1_SPI</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<p>We have a SPI Master and Slave to run on two different threads:</p>
<div class="highlight"><pre><span></span>#include &quot;mbed.h&quot;

Thread thread_master;
Thread thread_slave;

//master

SPI spi(D11, D12, D13); // mosi, miso, sclk
DigitalOut cs(D9);

SPISlave device(PD_4, PD_3, PD_1, PD_0); //mosi, miso, sclk, cs; PMOD pins

DigitalOut led(LED3);

int slave()
{
   device.format(8, 3);
   device.frequency(1000000);
   //device.reply(0x00); // Prime SPI with first reply
   while (1)
   {
      if (device.receive())
      {
            int v = device.read(); // Read byte from master
            printf(&quot;First Read from master: v = %0x\n&quot;, v);
            if (v == 0xAA)
            {                      //Verify the command
               v = device.read(); // Read another byte from master
               printf(&quot;Second Read from master: v = %d\n&quot;, v);
               v = v + 10;
               device.reply(v); // Make this the next reply
               v = device.read(); // Read again to allow master read back
               led = !led;      // led turn blue/orange if device receive
            }
            else
            {
               printf(&quot;Default reply to master: 0x00\n&quot;);
               device.reply(0x00); //Reply default value
            };
      }
   }
}

void master()
{
   int number = 0;

   // Setup the spi for 8 bit data, high steady state clock,
   // second edge capture, with a 1MHz clock rate
   spi.format(8, 3);
   spi.frequency(1000000);

   for(int i=0; i&lt;5; ++i){ //Run for 5 times
      // Chip must be deselected
      cs = 1;
      // Select the device by seting chip select low
      cs = 0;

      printf(&quot;Send handshaking codes.\n&quot;);

      int response = spi.write(0xAA); //Send ID
      cs = 1;                       // Deselect the device
      ThisThread::sleep_for(100ms); //Wait for debug print
      printf(&quot;First response from slave = %d\n&quot;, response);

      // Select the device by seting chip select low
      cs = 0;
      printf(&quot;Send number = %d\n&quot;, number);

      spi.write(number); //Send number to slave
      ThisThread::sleep_for(100ms); //Wait for debug print
      response = spi.write(number); //Read slave reply
      ThisThread::sleep_for(100ms); //Wait for debug print
      printf(&quot;Second response from slave = %d\n&quot;, response);
      cs = 1; // Deselect the device
      number += 1;
   }
}

int main()
{
   thread_slave.start(slave);
   thread_master.start(master);
}
</pre></div>
</li>
<li><p class="first">Compile and run the program. The results are <a class="reference external" href="labs/img/Serial_Communication/SPI_result.jpg">like this</a>.</p>
</li>
<li><p class="first">Record your results and push your codes to github.</p>
</li>
</ol>
</div>
<div class="section" id="mbed-uart-loopback">
<h3><a class="toc-backref" href="#toc-entry-7">4.3&nbsp;&nbsp;&nbsp;mbed UART loopback</a></h3>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<div class="section" id="uart-loopback-connection">
<h4><a class="toc-backref" href="#toc-entry-8">4.3.1&nbsp;&nbsp;&nbsp;UART Loopback Connection</a></h4>
<img alt="UART crossover connections with Picoscope" src="labs/img/Serial_Communication/UART_board.jpg" />
<ol class="arabic simple">
<li>Connect loop back UART wires between two UART Tx/Rx interfaces.<ol class="arabic">
<li>The <span class="hl">TX(D10) of master</span> is connected to the <span class="hl">RX(D0) of slave</span></li>
<li>The <span class="hl">RX(D9) of master</span> is connected to the <span class="hl">TX(D1) of slave</span></li>
</ol>
</li>
<li>Connect the UART to the picoscope<ol class="arabic">
<li>Connect the picoscope to your computer. <a class="reference external" href="labs/img/Analog_Input/1_1_2.jpg">Screenshot</a></li>
<li>Connect the first probe to the <span class="hl">Channel A</span> <a class="reference external" href="labs/img/Analog_Input/1_1_3.jpg">like this</a>.</li>
<li>Connect the probe to the pin named <span class="hl">TX(D10)</span> of master.</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="mbed-uart-loopback-program">
<h4><a class="toc-backref" href="#toc-entry-9">4.3.2&nbsp;&nbsp;&nbsp;mbed UART Loopback Program</a></h4>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>7_2_UART_loopback</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="cp">#define MAXIMUM_BUFFER_SIZE 6</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">static</span><span class="w"> </span><span class="n">DigitalOut</span><span class="w"> </span><span class="nf">led1</span><span class="p">(</span><span class="n">LED1</span><span class="p">);</span><span class="w"> </span><span class="c1">// led1 = PA_5</span>
<span class="linenos"> 6</span><span class="k">static</span><span class="w"> </span><span class="n">DigitalOut</span><span class="w"> </span><span class="nf">led2</span><span class="p">(</span><span class="n">LED2</span><span class="p">);</span><span class="w"> </span><span class="c1">// led2 = PB_14</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="n">Thread</span><span class="w"> </span><span class="n">thread1</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="n">Thread</span><span class="w"> </span><span class="n">thread2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="k">static</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="w"> </span><span class="nf">device1</span><span class="p">(</span><span class="n">D10</span><span class="p">,</span><span class="w"> </span><span class="n">D9</span><span class="p">);</span><span class="w"> </span><span class="c1">// tx, rx  D10:tx  D9:rx</span>
<span class="linenos">12</span><span class="k">static</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="w"> </span><span class="nf">device2</span><span class="p">(</span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">D0</span><span class="p">);</span><span class="w">  </span><span class="c1">// tx, rx   D1:tx   D0:rx</span>
<span class="linenos">13</span><span class="k">static</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="w"> </span><span class="nf">serial_port</span><span class="p">(</span><span class="n">USBTX</span><span class="p">,</span><span class="w"> </span><span class="n">USBRX</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="kt">void</span><span class="w"> </span><span class="nf">master_thread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buf1</span><span class="p">[</span><span class="n">MAXIMUM_BUFFER_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="sc">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">};</span><span class="w"></span>
<span class="linenos">17</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Blinking LED1 and LED2 in order twice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">18</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">    </span><span class="n">device1</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">    </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Waiting for command from terminal. 0: turn off both. 1: turn on LED1. 2: turn on LED2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">23</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="w"></span>
<span class="linenos">24</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serial_port</span><span class="p">.</span><span class="n">readable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">25</span><span class="w">          </span><span class="kt">char</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span>
<span class="linenos">26</span><span class="w">          </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serial_port</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">27</span><span class="w">          </span><span class="n">device1</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">28</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">29</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">30</span><span class="p">}</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">void</span><span class="w"> </span><span class="nf">slave_thread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">33</span><span class="w">  </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">34</span><span class="w">  </span><span class="n">led2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf2</span><span class="p">[</span><span class="n">MAXIMUM_BUFFER_SIZE</span><span class="p">];</span><span class="w"></span>
<span class="linenos">38</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">device2</span><span class="p">.</span><span class="n">readable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">39</span><span class="w">      </span><span class="n">device2</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">42</span><span class="w">        </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">43</span><span class="w">        </span><span class="n">led2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">44</span><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">45</span><span class="w">        </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">46</span><span class="w">        </span><span class="n">led2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">47</span><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">48</span><span class="w">        </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">49</span><span class="w">        </span><span class="n">led2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">50</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">51</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Got: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">52</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">53</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">54</span><span class="p">}</span><span class="w"></span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">57</span><span class="w">  </span><span class="c1">// Set desired properties (9600-8-N-1).</span>
<span class="linenos">58</span><span class="w">  </span><span class="n">device1</span><span class="p">.</span><span class="n">set_baud</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"></span>
<span class="linenos">59</span><span class="w">  </span><span class="n">device1</span><span class="p">.</span><span class="n">set_format</span><span class="p">(</span><span class="w"></span>
<span class="linenos">60</span><span class="w">      </span><span class="cm">/* bits */</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="linenos">61</span><span class="w">      </span><span class="cm">/* parity */</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="linenos">62</span><span class="w">      </span><span class="cm">/* stop bit */</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="w">  </span><span class="c1">// Set desired properties (9600-8-N-1).</span>
<span class="linenos">65</span><span class="w">  </span><span class="n">device2</span><span class="p">.</span><span class="n">set_baud</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="w"></span>
<span class="linenos">66</span><span class="w">  </span><span class="n">device2</span><span class="p">.</span><span class="n">set_format</span><span class="p">(</span><span class="w"></span>
<span class="linenos">67</span><span class="w">      </span><span class="cm">/* bits */</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"></span>
<span class="linenos">68</span><span class="w">      </span><span class="cm">/* parity */</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="o">::</span><span class="n">None</span><span class="p">,</span><span class="w"></span>
<span class="linenos">69</span><span class="w">      </span><span class="cm">/* stop bit */</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="w">  </span><span class="n">thread1</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">master_thread</span><span class="p">);</span><span class="w"></span>
<span class="linenos">72</span><span class="w">  </span><span class="n">thread2</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">slave_thread</span><span class="p">);</span><span class="w"></span>
<span class="linenos">73</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and flash the program.</p>
</li>
<li><p class="first">Quit Mbed Studio.</p>
</li>
<li><p class="first">Start CoolTerm app and connect to board with UART device (e.g. COM7 or /dev/cu.usbmodem14603).
Set &quot;Local Echo&quot; if you want to see the character you typed into CoolTerm.</p>
</li>
<li><p class="first">Rest the board and start the program.</p>
</li>
<li><p class="first">Push the reset button on B_L4S5I_IOT01A and the master thread will start and blinking LED1 and LED2 twice,
and go into a loop to take user input.</p>
<p>Enter '0' in CoolTerm terminal, the B_L4S5I_IOT01A will turn off both LED1 and LED2.</p>
<p>Enter '1' in CoolTerm terminal, the B_L4S5I_IOT01A will turn on the LED1 and turn off LED2.</p>
<p>Enter '2' in CoolTerm terminal, the B_L4S5I_IOT01A will turn on the LED2 and turn off LED1.</p>
</li>
<li><p class="first">Record your results and push your codes to github.</p>
</li>
</ol>
</div>
<div class="section" id="picoscope-uart-decoding">
<h4><a class="toc-backref" href="#toc-entry-10">4.3.3&nbsp;&nbsp;&nbsp;Picoscope UART Decoding</a></h4>
<ol class="arabic simple">
<li>Start the picoscope app.<ol class="arabic">
<li>Select &quot;input range A&quot; as <span class="hl">+-5V</span> and collection time as <span class="hl">1 ms/div</span>:<a class="reference external" href="labs/img/Analog_Input/3_1_1.png">screenshot</a></li>
<li>Choose <span class="hl">Tools</span> -&gt; <span class="hl">Serial Decoding</span> <a class="reference external" href="labs/img/Serial_Communication/step1.png">like this</a>.</li>
<li>Choose <span class="hl">UART(RS-232, RS-422, RS-485)</span> <a class="reference external" href="labs/img/Serial_Communication/step2.png">like this</a> and <a class="reference external" href="labs/img/Serial_Communication/step2_2.png">this</a>.</li>
<li>Choose <span class="hl">Add</span>, change <span class="hl">Data</span>, <span class="hl">Baud Rate</span>, and <span class="hl">Display</span> <a class="reference external" href="labs/img/Serial_Communication/step3.png">like this</a> and <a class="reference external" href="labs/img/Serial_Communication/step3_2.png">this</a>.</li>
</ol>
</li>
<li>The UART waveform will show on the monitor.
The waveform may look like <a class="reference external" href="labs/img/Serial_Communication/char_0.png">this</a>.</li>
<li>Record your results and push your codes to github.</li>
</ol>
</div>
</div>
<div class="section" id="build-your-own-lcd-library-i2c-version">
<h3><a class="toc-backref" href="#toc-entry-11">4.4&nbsp;&nbsp;&nbsp;Build your own LCD library I2C version</a></h3>
<p>In this part, we build another library for a I2C version of text LCD.  We only
need two wires (SDA and SDL) for connection as compared to 12-wire interface of
QC1602A.</p>
<p>The program structure of the I2C version is similar to the QC1602A except for
the I2C interface. In the I2C version, we encode the parallel-wire bits into
a <strong>char</strong> for both command and data. And then we use i2c.write() to send the
char to the I2C bus, which will be converted to parallel signals as QC1602A.</p>
<ol class="arabic">
<li><p class="first">Connect your LCD to mbed as the following. <a class="reference external" href="labs/img/Serial_Communication/LCD_board.jpg">picture</a> .</p>
<div class="warning docutils container">
<p><strong>Please be careful about pin connections. Double check before you turn on the power.</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">LCD</th>
<th class="head">mbed</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>VCC</td>
<td>5V</td>
</tr>
<tr><td>GND</td>
<td>GND</td>
</tr>
<tr><td>SDA</td>
<td>SDA</td>
</tr>
<tr><td>SCL</td>
<td>SCL</td>
</tr>
</tbody>
</table>
</div>
</li>
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>7_3_textLCD_I2C</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LCD.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 4</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">      </span><span class="n">LCD_init</span><span class="p">();</span><span class="w">                     </span><span class="c1">// call the initialise function</span>
<span class="linenos"> 6</span><span class="w">      </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="mh">0x48</span><span class="p">);</span><span class="w">           </span><span class="c1">// ‘H’</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="mh">0x45</span><span class="p">);</span><span class="w">           </span><span class="c1">// ‘E’</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="mh">0x4C</span><span class="p">);</span><span class="w">           </span><span class="c1">// ‘L’</span>
<span class="linenos"> 9</span><span class="w">      </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="mh">0x4C</span><span class="p">);</span><span class="w">           </span><span class="c1">// ‘L’</span>
<span class="linenos">10</span><span class="w">      </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="mh">0x4F</span><span class="p">);</span><span class="w">           </span><span class="c1">// ‘O’</span>
<span class="linenos">11</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mh">0x30</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;=</span><span class="mh">0x39</span><span class="p">;</span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">12</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos">13</span><span class="w">            </span><span class="n">display_to_LCD</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">      </span><span class="c1">// display numbers 0-9</span>
<span class="linenos">14</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Add a LCD.h under 7_3_textLCD_I2C. And enter the following source code in LCD.h.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#ifndef LCD_H</span>
<span class="linenos"> 2</span><span class="cp">#define LCD_H</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define LCD_BUS_I2C_RS (1 &lt;&lt; 0)</span>
<span class="linenos"> 8</span><span class="cp">#define LCD_BUS_I2C_RW (1 &lt;&lt; 1)</span>
<span class="linenos"> 9</span><span class="cp">#define LCD_BUS_I2C_E  (1 &lt;&lt; 2)</span>
<span class="linenos">10</span><span class="cp">#define LCD_BUS_I2C_BL (1 &lt;&lt; 3)</span>
<span class="linenos">11</span><span class="cp">#define LCD_BUS_I2C_D4 (1 &lt;&lt; 4)</span>
<span class="linenos">12</span><span class="cp">#define LCD_BUS_I2C_D5 (1 &lt;&lt; 5)</span>
<span class="linenos">13</span><span class="cp">#define LCD_BUS_I2C_D6 (1 &lt;&lt; 6)</span>
<span class="linenos">14</span><span class="cp">#define LCD_BUS_I2C_D7 (1 &lt;&lt; 7)</span>
<span class="linenos">15</span><span class="cp">#define LCD_BUS_I2C_MSK (LCD_BUS_I2C_D4 | LCD_BUS_I2C_D5 | LCD_BUS_I2C_D6 | LCD_BUS_I2C_D7)</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="c1">// void toggle_enable(void);      //function to toggle/pulse the enable bit</span>
<span class="linenos">18</span><span class="kt">void</span><span class="w"> </span><span class="nf">LCD_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w">             </span><span class="c1">//function to initialise the LCD</span>
<span class="linenos">19</span><span class="kt">void</span><span class="w"> </span><span class="nf">display_to_LCD</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">  </span><span class="c1">//function to display characters</span>
<span class="linenos">20</span><span class="kt">void</span><span class="w"> </span><span class="nf">_setDataBits</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span><span class="kt">void</span><span class="w"> </span><span class="nf">_writeByte</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="linenos">22</span><span class="kt">void</span><span class="w"> </span><span class="nf">_writeCommand</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="cp">#endif</span>
</pre></div>
</li>
<li><p class="first">Add a LCD.cpp under 7_3_textLCD_I2C. And enter the following source code in LCD.cpp.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LCD.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">I2C</span><span class="w"> </span><span class="nf">_i2c</span><span class="p">(</span><span class="n">D14</span><span class="p">,</span><span class="w"> </span><span class="n">D15</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kt">char</span><span class="w"> </span><span class="n">_slaveAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4E</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span><span class="kt">char</span><span class="w"> </span><span class="n">_lcd_bus</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kt">void</span><span class="w"> </span><span class="nf">display_to_LCD</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 8</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_RS</span><span class="p">;</span><span class="w"> </span><span class="c1">// Set RS bit</span>
<span class="linenos">10</span><span class="w">      </span><span class="n">_i2c</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">_slaveAddress</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_lcd_bus</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">11</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="w">      </span><span class="n">_writeByte</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">40</span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="p">}</span><span class="w"></span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="c1">//initialise LCD function</span>
<span class="linenos">17</span><span class="kt">void</span><span class="w"> </span><span class="nf">LCD_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="linenos">18</span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">      </span><span class="n">_i2c</span><span class="p">.</span><span class="n">frequency</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">20</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">      </span><span class="n">_writeCommand</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span><span class="w"></span>
<span class="linenos">23</span><span class="w">      </span><span class="c1">// Controller is now in 4-bit mode</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">      </span><span class="n">_writeCommand</span><span class="p">(</span><span class="mh">0x28</span><span class="p">);</span><span class="w"> </span><span class="c1">// Function set 001 DL N F - -</span>
<span class="linenos">26</span><span class="w">                           </span><span class="c1">//  DL(Data Length)=0 (4 bits bus)</span>
<span class="linenos">27</span><span class="w">                           </span><span class="c1">//  N=1 (2 lines)</span>
<span class="linenos">28</span><span class="w">                           </span><span class="c1">//  F=0 (5x7 dots font, only option for 2 line display)</span>
<span class="linenos">29</span><span class="w">                           </span><span class="c1">//  -  (Don&#39;t care)</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">10</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">      </span><span class="c1">// display mode</span>
<span class="linenos">34</span><span class="w">      </span><span class="n">_writeCommand</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">);</span><span class="w"> </span><span class="c1">// display on, cursor on,  blink on  ; Display Ctrl 0000 1 D C B</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">      </span><span class="n">_writeCommand</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="w"> </span><span class="c1">// cls, and set cursor to 0</span>
<span class="linenos">37</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">20</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">      </span><span class="c1">// _writeCommand(0x80);</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">      </span><span class="c1">//set cursor blink (0x1)</span>
<span class="linenos">42</span><span class="w">      </span><span class="c1">// _writeCommand(0x0D);</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">      </span><span class="c1">// set backlight</span>
<span class="linenos">45</span><span class="w">      </span><span class="c1">// _lcd_bus |= LCD_BUS_I2C_BL;</span>
<span class="linenos">46</span><span class="w">      </span><span class="c1">// _i2c.write(_slaveAddress, &amp;_lcd_bus, 1);</span>
<span class="linenos">47</span><span class="p">}</span><span class="w"></span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="kt">void</span><span class="w"> </span><span class="nf">_setDataBits</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos">50</span><span class="p">{</span><span class="w"></span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="w">      </span><span class="c1">//Clear all databits</span>
<span class="linenos">53</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LCD_BUS_I2C_MSK</span><span class="p">;</span><span class="w"></span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">      </span><span class="c1">// Set bit by bit to support any mapping of expander portpins to LCD pins</span>
<span class="linenos">56</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_D4</span><span class="p">;</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1">// Set Databit</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_D5</span><span class="p">;</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1">// Set Databit</span>
<span class="linenos">59</span>
<span class="linenos">60</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_D6</span><span class="p">;</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1">// Set Databit</span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_D7</span><span class="p">;</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1">// Set Databit</span>
<span class="linenos">63</span><span class="p">}</span><span class="w"></span>
<span class="linenos">64</span>
<span class="linenos">65</span><span class="kt">void</span><span class="w"> </span><span class="nf">_writeByte</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="linenos">66</span><span class="p">{</span><span class="w"></span>
<span class="linenos">67</span><span class="w">      </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="linenos">68</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_E</span><span class="p">;</span><span class="w"> </span><span class="c1">// Set E bit</span>
<span class="linenos">69</span><span class="w">      </span><span class="n">_setDataBits</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w">  </span><span class="c1">// set data high</span>
<span class="linenos">70</span><span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_lcd_bus</span><span class="p">;</span><span class="w"></span>
<span class="linenos">71</span>
<span class="linenos">72</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LCD_BUS_I2C_E</span><span class="p">;</span><span class="w"> </span><span class="c1">// clear E</span>
<span class="linenos">73</span><span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_lcd_bus</span><span class="p">;</span><span class="w"></span>
<span class="linenos">74</span>
<span class="linenos">75</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">LCD_BUS_I2C_E</span><span class="p">;</span><span class="w"> </span><span class="c1">// Set E bit</span>
<span class="linenos">76</span><span class="w">      </span><span class="n">_setDataBits</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">       </span><span class="c1">// set data low</span>
<span class="linenos">77</span><span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_lcd_bus</span><span class="p">;</span><span class="w"></span>
<span class="linenos">78</span>
<span class="linenos">79</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LCD_BUS_I2C_E</span><span class="p">;</span><span class="w"> </span><span class="c1">// clear E</span>
<span class="linenos">80</span><span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_lcd_bus</span><span class="p">;</span><span class="w"></span>
<span class="linenos">81</span>
<span class="linenos">82</span><span class="w">      </span><span class="c1">// write the packed data to the I2C portexpander</span>
<span class="linenos">83</span><span class="w">      </span><span class="n">_i2c</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">_slaveAddress</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="linenos">84</span><span class="p">}</span><span class="w"></span>
<span class="linenos">85</span>
<span class="linenos">86</span><span class="kt">void</span><span class="w"> </span><span class="nf">_writeCommand</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"></span>
<span class="linenos">87</span><span class="p">{</span><span class="w"></span>
<span class="linenos">88</span><span class="w">      </span><span class="n">_lcd_bus</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">LCD_BUS_I2C_RS</span><span class="p">;</span><span class="w"> </span><span class="c1">// Reset RS bit</span>
<span class="linenos">89</span><span class="w">      </span><span class="n">_i2c</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">_slaveAddress</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_lcd_bus</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">90</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="linenos">91</span><span class="w">      </span><span class="n">_writeByte</span><span class="p">(</span><span class="n">command</span><span class="p">);</span><span class="w"></span>
<span class="linenos">92</span><span class="w">      </span><span class="n">ThisThread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">40</span><span class="n">ms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// most instructions take 40us</span>
<span class="linenos">93</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and run the program.</p>
</li>
<li><p class="first">Record your results and push your codes to github.</p>
</li>
</ol>
</div>
<div class="section" id="import-textlcd-library-for-i2c">
<h3><a class="toc-backref" href="#toc-entry-12">4.5&nbsp;&nbsp;&nbsp;Import TextLCD library for I2C</a></h3>
<p>Here we import a I2C TextLCD library to control the text LCD module.
This part is similar to textLCD library in mbed Lab 5 but with an I2C interface for LCD module.</p>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>7_4_textLCD_Library</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Add a library to the current project</p>
<ol class="arabic simple">
<li>Click <strong>+</strong> in the Library tab under program source.</li>
<li>Fill in <cite>https://gitlab.larc-nthu.net/ee2405_2021/textlcd.git</cite>
And click &quot;Next&quot;</li>
<li>Select &quot;Master&quot; branch and click &quot;Finish&quot;</li>
</ol>
</li>
<li><p class="first">Configure the textLCD library</p>
<p>Edit <span class="file">TextLCD_Config.h</span> under <span class="file">textlcd</span></p>
<p>Go to line 71, change it from <code class="cmd-host">#define DEFAULT        1</code> to <code class="cmd-host">#define DEFAULT        0</code></p>
<p>Go to line 75, change it from <code class="cmd-host">#define YWROBOT        0</code> to <code class="cmd-host">#define YWROBOT        1</code></p>
<p>So you will have the something like the following</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#define DEFAULT        0</span>
<span class="linenos"> 2</span><span class="cp">#define ADAFRUIT       0</span>
<span class="linenos"> 3</span><span class="cp">#define DFROBOT        0</span>
<span class="linenos"> 4</span><span class="cp">#define LCM1602        0</span>
<span class="linenos"> 5</span><span class="cp">#define YWROBOT        1</span>
<span class="linenos"> 6</span><span class="cp">#define GYLCD          0</span>
<span class="linenos"> 7</span><span class="cp">#define MJKDZ          0</span>
<span class="linenos"> 8</span><span class="cp">#define SYDZ           0</span>
<span class="linenos"> 9</span><span class="cp">#define WIDEHK         0</span>
<span class="linenos">10</span><span class="cp">#define LCDPLUG        0</span>
</pre></div>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TextLCD.h&quot;</span><span class="cp"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1">// Host PC Communication channels</span>
<span class="linenos"> 5</span><span class="k">static</span><span class="w"> </span><span class="n">BufferedSerial</span><span class="w"> </span><span class="nf">pc</span><span class="p">(</span><span class="n">USBTX</span><span class="p">,</span><span class="w"> </span><span class="n">USBRX</span><span class="p">);</span><span class="w"> </span><span class="c1">// tx, rx</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c1">// I2C Communication</span>
<span class="linenos"> 8</span><span class="n">I2C</span><span class="w"> </span><span class="nf">i2c_lcd</span><span class="p">(</span><span class="n">D14</span><span class="p">,</span><span class="w"> </span><span class="n">D15</span><span class="p">);</span><span class="w"> </span><span class="c1">// SDA, SCL</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="c1">//TextLCD_SPI lcd(&amp;spi_lcd, p8, TextLCD::LCD40x4);   // SPI bus, 74595 expander, CS pin, LCD Type</span>
<span class="linenos">11</span><span class="n">TextLCD_I2C</span><span class="w"> </span><span class="nf">lcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_lcd</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4E</span><span class="p">,</span><span class="w"> </span><span class="n">TextLCD</span><span class="o">::</span><span class="n">LCD16x2</span><span class="p">);</span><span class="w">   </span><span class="c1">// I2C bus, PCF8574 Slaveaddress, LCD Type</span>
<span class="linenos">12</span><span class="w">                                                     </span><span class="c1">//TextLCD_I2C lcd(&amp;i2c_lcd, 0x42, TextLCD::LCD16x2, TextLCD::WS0010);</span>
<span class="linenos">13</span><span class="w">                                                     </span><span class="c1">// I2C bus, PCF8574 Slaveaddress, LCD Type, Device Type</span>
<span class="linenos">14</span><span class="w">                                                     </span><span class="c1">//TextLCD_SPI_N lcd(&amp;spi_lcd, p8, p9);</span>
<span class="linenos">15</span><span class="w">                                                     </span><span class="c1">// SPI bus, CS pin, RS pin, LCDType=LCD16x2, BL=NC, LCDTCtrl=ST7032_3V3</span>
<span class="linenos">16</span><span class="c1">//TextLCD_I2C_N lcd(&amp;i2c_lcd, ST7032_SA, TextLCD::LCD16x2, NC, TextLCD::ST7032_3V3);</span>
<span class="linenos">17</span><span class="c1">// I2C bus, Slaveaddress, LCD Type, BL=NC, LCDTCtrl=ST7032_3V3</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="n">FileHandle</span><span class="w"> </span><span class="o">*</span><span class="nf">mbed::mbed_override_console</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">20</span><span class="p">{</span><span class="w"></span>
<span class="linenos">21</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pc</span><span class="p">;</span><span class="w"></span>
<span class="linenos">22</span><span class="p">}</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="linenos">25</span><span class="p">{</span><span class="w"></span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">   </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;LCD Test. Columns=%d, Rows=%d</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">columns</span><span class="p">(),</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">rows</span><span class="p">());</span><span class="w"></span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">rows</span><span class="p">();</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">30</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos">31</span><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">32</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;MemAddr(Col=%d, Row=%d)=0x%02X</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">getAddress</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">));</span><span class="w"></span>
<span class="linenos">33</span><span class="w">      </span><span class="c1">//      lcd.putc(&#39;-&#39;);</span>
<span class="linenos">34</span><span class="w">      </span><span class="n">lcd</span><span class="p">.</span><span class="n">putc</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">row</span><span class="p">);</span><span class="w"></span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">columns</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">col</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">37</span><span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="linenos">38</span><span class="w">      </span><span class="n">lcd</span><span class="p">.</span><span class="n">putc</span><span class="p">(</span><span class="sc">&#39;*&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">39</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;MemAddr(Col=%d, Row=%d)=0x%02X</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">lcd</span><span class="p">.</span><span class="n">getAddress</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">));</span><span class="w"></span>
<span class="linenos">42</span><span class="w">      </span><span class="n">lcd</span><span class="p">.</span><span class="n">putc</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">43</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">   </span><span class="c1">// Show cursor as blinking character</span>
<span class="linenos">46</span><span class="w">   </span><span class="n">lcd</span><span class="p">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">TextLCD</span><span class="o">::</span><span class="n">CurOff_BlkOn</span><span class="p">);</span><span class="w"></span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="w">   </span><span class="c1">// Set and show user defined characters. A maximum of 8 UDCs are supported by the HD44780.</span>
<span class="linenos">49</span><span class="w">   </span><span class="c1">// They are defined by a 5x7 bitpattern.</span>
<span class="linenos">50</span><span class="w">   </span><span class="n">lcd</span><span class="p">.</span><span class="n">setUDC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">udc_0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Show |&gt;</span>
<span class="linenos">51</span><span class="w">   </span><span class="n">lcd</span><span class="p">.</span><span class="n">putc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">                  </span><span class="c1">//lcd.putc(0);</span>
<span class="linenos">52</span><span class="w">   </span><span class="n">lcd</span><span class="p">.</span><span class="n">setUDC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">udc_1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Show &lt;|</span>
<span class="linenos">53</span><span class="w">   </span><span class="n">lcd</span><span class="p">.</span><span class="n">putc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">                  </span><span class="c1">//lcd.putc(1);</span>
<span class="linenos">54</span><span class="p">}</span><span class="w"></span>
</pre></div>
</li>
<li><p class="first">Compile and run the program.</p>
</li>
<li><p class="first">Record your results and push your codes to github.</p>
</li>
</ol>
</div>
<div class="section" id="tmp102-with-i2c">
<h3><a class="toc-backref" href="#toc-entry-13">4.6&nbsp;&nbsp;&nbsp;TMP102 with I2C</a></h3>
<p>TMP102 is a temperature measurement sensor module with a I2C interface.
We also use Picoscope to read the I2C signal patterns from TMP102.</p>
<div class="warning docutils container">
For the following, please unplug B_L4S5I_IOT01A from power while wiring circuits.</div>
<div class="section" id="connect-to-tmp102-with-i2c">
<h4><a class="toc-backref" href="#toc-entry-14">4.6.1&nbsp;&nbsp;&nbsp;Connect to TMP102 with I2C</a></h4>
<ol class="arabic">
<li><p class="first">Connect B_L4S5I_IOT01A to TMP102.</p>
<p>To connect this I2C sensor to B_L4S5I_IOT01A, we need to connect <span class="hl">SCL</span> and <span class="hl">SDA</span> to B_L4S5I_IOT01A.</p>
<p>Here is the example about connect I2C to B_L4S5I_IOT01A. <a class="reference external" href="labs/img/Serial_Communication/new_TMP_.png">Picture</a></p>
</li>
</ol>
</div>
<div class="section" id="connect-picoscope-to-i2c">
<h4><a class="toc-backref" href="#toc-entry-15">4.6.2&nbsp;&nbsp;&nbsp;Connect Picoscope to I2C</a></h4>
<ol class="arabic">
<li><p class="first">Connect Picoscope probes to the <span class="hl">Channel A</span> and <span class="hl">Channel B</span>.</p>
</li>
<li><p class="first">Connect the probe to I2C pins</p>
<ul class="simple">
<li>Connect probe A with the pin named <span class="hl">SDA(D14)</span></li>
<li>Connect probe B with the pin named <span class="hl">SCL(D15)</span></li>
</ul>
<img alt="TMP 102 schematic" src="labs/img/Serial_Communication/new_TMP_.png" />
</li>
</ol>
</div>
<div class="section" id="create-a-program-to-read-tmp102">
<h4><a class="toc-backref" href="#toc-entry-16">4.6.3&nbsp;&nbsp;&nbsp;Create a Program to Read TMP102</a></h4>
<ol class="arabic">
<li><p class="first">Create a new program.</p>
</li>
<li><p class="first">Open the <strong>File</strong> menu and select <strong>New Program....</strong></p>
</li>
<li><p class="first">Select &quot;empty Mbed OS program&quot; under <strong>MBED OS 6</strong>
Enter <em>7_5_TMP102</em> for Program name.
Check &quot;Make this the active program&quot; (default).
Under &quot;<strong>Mbed OS Location</strong>&quot;, check &quot;Link to an existing shared Mbed OS instance&quot;
and select &quot;~/Mbed Programs/mbed01/mbed-os/&quot;. This will reuse Mbed OS in mbed01/.
Click &quot;Add Program&quot;.</p>
</li>
<li><p class="first">Copy the following codes into <span class="file">main.cpp</span>.</p>
<div class="highlight"><pre><span></span>#include &quot;mbed.h&quot;

I2C m_i2c(D14, D15);
char m_addr = 0x90;
int main()
{
   while (1)
   {
      const char tempRegAddr = 0x00;

      m_i2c.write(m_addr, &amp;tempRegAddr, 1);
      //Set pointer to the temperature register

      char reg[2] = {0, 0};
      m_i2c.read(m_addr, reg, 2); //Read

      unsigned short res = (reg[0] &lt;&lt; 4) | (reg[1] &gt;&gt; 4);
      float temp =  (float) ((float)res * 0.0625);
      printf(&quot;Temp code=(%d, %d)\r\n&quot;, reg[0], reg[1]);
      printf(&quot;Temp = %f.\r\n&quot;, temp);
      ThisThread::sleep_for(1s);
   }
}
</pre></div>
</li>
<li><p class="first">Compile and run the program.
As a result, <span class="hl">TMP102</span> will start to return the temperature to your terminal <a class="reference external" href="labs/img/Serial_Communication/I2C_temp.jpg">like this</a>.</p>
</li>
<li><p class="first">Record your results and push your codes to github.</p>
</li>
<li><p class="first">Start the picoscope app</p>
<ol class="arabic simple">
<li>Setup the picoscope<ul>
<li>Select &quot;input range A&quot; and &quot;input range B&quot; as <span class="hl">+-5</span></li>
<li>collection time as <span class="hl">1 ms/div</span></li>
<li>Number of sample as <span class="hl">100 kS</span></li>
<li>Stop recording and move the view scope to have your target signal to zoom in like <a class="reference external" href="labs/img/Serial_Communication/I2C_wave.jpg">this</a>.</li>
</ul>
</li>
</ol>
</li>
<li><p class="first">The I2C waveform will shows on the <a class="reference external" href="labs/img/Serial_Communication/I2C_waveDetail.jpg">monitor</a>.</p>
</li>
<li><p class="first">Record your results and push your codes to GitHub repo.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="checkpoints">
<h2><a class="toc-backref" href="#toc-entry-17">5&nbsp;&nbsp;&nbsp;Checkpoints</a></h2>
<ol class="arabic simple">
<li>Know how to transfer data via UART.</li>
<li>Configure the UART setting, like baud rate.</li>
<li>Know how to send command to I2C module.</li>
<li>Show your git remote repository.</li>
</ol>
</div>
<div class="section" id="reference-list">
<h2><a class="toc-backref" href="#toc-entry-18">6&nbsp;&nbsp;&nbsp;Reference List</a></h2>
<ol class="arabic simple">
<li><a class="reference external" href="https://os.mbed.com/docs/mbed-os/v6.15/apis/spi.html">mbed SPI</a></li>
<li><a class="reference external" href="https://os.mbed.com/docs/mbed-os/v6.15/apis/i2c.html">mbed I2C</a></li>
<li><a class="reference external" href="https://os.mbed.com/docs/mbed-os/v6.15/apis/serial-uart-apis.html">mbed UART Serial</a></li>
</ol>
</div>

            </div><!-- /.entry-content -->


        </div><!-- /.eleven.columns -->

<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="https://ee2405.github.io/pages/lab-schedule.html">Lab Schedule</a></li>
      <li><a href="https://ee2405.github.io/pages/class-rules.html">Class Rules</a></li>
  </ul>

<h4>Categories</h4>
<ul class="blank">
		<li><a href="https://ee2405.github.io/category/homework.html">homework</a></li>
		<li><a href="https://ee2405.github.io/category/labs.html">labs</a></li>
		<li><a href="https://ee2405.github.io/category/misc.html">misc</a></li>
		<li><a href="https://ee2405.github.io/category/tutorial.html">tutorial</a></li>
</ul>





</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">





              </ul>
            </div>
          </div>
        </footer>

    </div>


  <script src="https://ee2405.github.io/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="https://ee2405.github.io/theme/js/libs/gumby.min.js"></script>
  <script src="https://ee2405.github.io/theme/js/plugins.js"></script>
</body>
</html>